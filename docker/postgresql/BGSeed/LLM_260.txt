CREATE TABLE products (
    product_no integer,
    name text,
    price numeric
);

CREATE TABLE orders (
    order_id integer,
    customer_id integer,
    order_date date
);

CREATE TABLE order_items (
    order_id integer,
    product_no integer,
    quantity integer
);

INSERT INTO products (product_no, name, price) VALUES
    (1, 'Cheese', 9.99),
    (2, 'Bread', 2.49),
    (3, 'Milk', 3.50);

INSERT INTO orders (order_id, customer_id, order_date) VALUES
    (101, 1, '2024-01-15'),
    (102, 2, '2024-01-20'),
    (103, 1, '2024-01-25');

INSERT INTO order_items (order_id, product_no, quantity) VALUES
    (101, 1, 2),
    (101, 2, 1),
    (102, 3, 3),
    (103, 1, 1),
    (103, 3, 2);

SELECT p.name, SUM(oi.quantity) AS total_quantity
FROM products p
JOIN order_items oi ON p.product_no = oi.product_no
GROUP BY p.name
ORDER BY total_quantity DESC;

SELECT o.order_id, c.customer_id, o.order_date
FROM orders o
LEFT JOIN (SELECT customer_id FROM orders GROUP BY customer_id HAVING COUNT(*) > 1) c
ON o.customer_id = c.customer_id;

CREATE INDEX idx_products_name ON products (name);

CREATE VIEW customer_orders AS
SELECT o.order_id, o.customer_id, o.order_date, p.name AS product_name, oi.quantity
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_no = p.product_no;

SELECT * FROM customer_orders WHERE customer_id = 1;

CREATE OR REPLACE FUNCTION get_product_price(product_name text)
RETURNS numeric AS $$
BEGIN
    RETURN (SELECT price FROM products WHERE name = product_name);
END;
$$ LANGUAGE plpgsql;

SELECT get_product_price('Cheese');

ALTER TABLE products ADD COLUMN description text;

UPDATE products SET description = 'Delicious cheese' WHERE product_no = 1;
UPDATE products SET description = 'Fresh bread' WHERE product_no = 2;
UPDATE products SET description = 'Healthy milk' WHERE product_no = 3;

SELECT * FROM products WHERE description LIKE '%cheese%';

DELETE FROM order_items WHERE order_id = 102 AND product_no = 3;

DROP VIEW customer_orders;

DROP FUNCTION get_product_price(text);

DROP INDEX idx_products_name;

DROP TABLE order_items;

DROP TABLE orders;

DROP TABLE products;