CREATE TABLE employees (
    employee_id SERIAL PRIMARY KEY,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    email VARCHAR(100) UNIQUE,
    phone_number VARCHAR(20),
    hire_date DATE,
    job_id INTEGER,
    salary DECIMAL(10, 2),
    commission_pct DECIMAL(4, 2),
    manager_id INTEGER,
    department_id INTEGER
);

CREATE TABLE departments (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(50) UNIQUE,
    location_id INTEGER
);

CREATE TABLE jobs (
    job_id SERIAL PRIMARY KEY,
    job_title VARCHAR(50) UNIQUE,
    min_salary DECIMAL(10, 2),
    max_salary DECIMAL(10, 2)
);

CREATE TABLE locations (
    location_id SERIAL PRIMARY KEY,
    address VARCHAR(100),
    postal_code VARCHAR(20),
    city VARCHAR(50),
    state_province VARCHAR(50),
    country_id VARCHAR(2)
);

CREATE TABLE countries (
    country_id VARCHAR(2) PRIMARY KEY,
    country_name VARCHAR(50),
    region_id INTEGER
);

CREATE TABLE regions (
    region_id SERIAL PRIMARY KEY,
    region_name VARCHAR(50)
);

ALTER TABLE employees ADD CONSTRAINT fk_employees_job_id FOREIGN KEY (job_id) REFERENCES jobs (job_id);
ALTER TABLE employees ADD CONSTRAINT fk_employees_department_id FOREIGN KEY (department_id) REFERENCES departments (department_id);
ALTER TABLE employees ADD CONSTRAINT fk_employees_manager_id FOREIGN KEY (manager_id) REFERENCES employees (employee_id);
ALTER TABLE departments ADD CONSTRAINT fk_departments_location_id FOREIGN KEY (location_id) REFERENCES locations (location_id);
ALTER TABLE locations ADD CONSTRAINT fk_locations_country_id FOREIGN KEY (country_id) REFERENCES countries (country_id);
ALTER TABLE countries ADD CONSTRAINT fk_countries_region_id FOREIGN KEY (region_id) REFERENCES regions (region_id);

INSERT INTO regions (region_name) VALUES ('Europe');
INSERT INTO countries (country_id, country_name, region_id) VALUES ('US', 'United States', 1);
INSERT INTO locations (address, postal_code, city, state_province, country_id) VALUES ('123 Main St', '12345', 'Anytown', 'CA', 'US');
INSERT INTO departments (department_name, location_id) VALUES ('Sales', 1);
INSERT INTO jobs (job_title, min_salary, max_salary) VALUES ('Sales Representative', 40000.00, 70000.00);
INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES ('John', 'Doe', 'john.doe@example.com', '2023-01-15', 1, 50000.00, 1);

SELECT * FROM employees WHERE salary > 45000;
UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;
DELETE FROM employees WHERE employee_id = 1;

-- Using PostgreSQL specific features
CREATE EXTENSION IF NOT EXISTS pg_trgm;
SELECT * FROM employees WHERE first_name % 'Joh'; -- Trigram similarity
CREATE INDEX trgm_idx ON employees USING gin (first_name gin_trgm_ops);

-- JSON Support
CREATE TABLE products (id SERIAL PRIMARY KEY, data JSONB);
INSERT INTO products (data) VALUES ('{"name": "Laptop", "price": 1200}');
SELECT data ->> 'name' FROM products WHERE data ->> 'price' > '1000';

-- Array Support
CREATE TABLE tags (id SERIAL PRIMARY KEY, tag_list TEXT[]);
INSERT INTO tags (tag_list) VALUES (ARRAY['programming', 'postgres', 'sql']);
SELECT tag_list[1] FROM tags;
SELECT * FROM tags WHERE 'postgres' = ANY(tag_list);

-- Window functions
SELECT department_name, AVG(salary) OVER (PARTITION BY department_id) FROM employees JOIN departments ON employees.department_id = departments.department_id;

-- Common Table Expressions (CTEs)
WITH high_earners AS (
    SELECT employee_id, first_name, last_name FROM employees WHERE salary > 60000
)
SELECT * FROM high_earners;

-- Generate a sequence
CREATE SEQUENCE my_sequence START WITH 100 INCREMENT BY 5;
SELECT nextval('my_sequence');

-- Using generate_series
SELECT generate_series(1, 10);

-- Check constraint
ALTER TABLE employees ADD CONSTRAINT check_salary CHECK (salary > 0);

-- Unique index
CREATE UNIQUE INDEX email_idx ON employees (email);

-- Exclusion constraint (requires extension)
CREATE EXTENSION IF NOT EXISTS btree_gist;
CREATE TABLE reservations (
    room int,
    during tsrange,
    EXCLUDE USING gist (room WITH =, during WITH &&)
);

-- Full Text Search
ALTER TABLE products ADD COLUMN tsvector_document tsvector;
UPDATE products SET tsvector_document = to_tsvector('english', data::text);
CREATE INDEX ts_idx ON products USING gin (tsvector_document);
SELECT * FROM products WHERE tsvector_document @@ to_tsquery('english', 'laptop');