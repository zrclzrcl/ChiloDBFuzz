DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS customers;
DROP TABLE IF EXISTS orders;

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(255) NOT NULL,
    price DECIMAL(10, 2)
);

CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    email VARCHAR(255) UNIQUE
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers(customer_id),
    order_date DATE,
    total_amount DECIMAL(10, 2)
);

INSERT INTO products (product_name, price) VALUES
('Laptop', 1200.00),
('Mouse', 25.00),
('Keyboard', 75.00),
('Monitor', 300.00);

INSERT INTO customers (first_name, last_name, email) VALUES
('John', 'Doe', 'john.doe@example.com'),
('Jane', 'Smith', 'jane.smith@example.com');

INSERT INTO orders (customer_id, order_date, total_amount) VALUES
(1, '2024-01-15', 1225.00),
(2, '2024-01-20', 375.00);

SELECT * FROM products WHERE price > 50.00;
SELECT product_name FROM products ORDER BY price DESC;
SELECT COUNT(*) FROM customers;
SELECT AVG(total_amount) FROM orders;
SELECT c.first_name, o.order_date FROM customers c JOIN orders o ON c.customer_id = o.customer_id;
SELECT * FROM products WHERE product_name LIKE '%o%';
SELECT * FROM products WHERE product_name ILIKE '%o%';
UPDATE products SET price = 1300.00 WHERE product_name = 'Laptop';
DELETE FROM products WHERE product_id = 2;

-- PostgreSQL Specific Features
CREATE EXTENSION IF NOT EXISTS pgcrypto;
SELECT gen_random_uuid();

CREATE TABLE json_test (
  id SERIAL PRIMARY KEY,
  data JSONB
);

INSERT INTO json_test (data) VALUES
('{"name": "Example", "value": 123}');

SELECT data -> 'name' FROM json_test;
SELECT data ->> 'name' FROM json_test;

SELECT generate_series(1, 10);

CREATE INDEX product_name_idx ON products (product_name);

ALTER TABLE customers ADD COLUMN phone_number VARCHAR(20);

UPDATE customers SET phone_number = '555-123-4567' WHERE customer_id = 1;

SELECT * FROM customers WHERE phone_number IS NOT NULL;

-- More complex query
SELECT c.first_name, SUM(o.total_amount) AS total_spent
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.first_name
ORDER BY total_spent DESC;

-- Using window functions
SELECT product_name, price,
       RANK() OVER (ORDER BY price DESC) AS price_rank
FROM products;

-- Using common table expressions (CTEs)
WITH high_price_products AS (
  SELECT product_name, price
  FROM products
  WHERE price > 100
)
SELECT * FROM high_price_products
ORDER BY price DESC;

-- More string functions
SELECT substring(first_name from 1 for 3) from customers;
SELECT upper(last_name) from customers;

-- Create a function (for demonstration, not necessarily useful in fuzzing)
CREATE OR REPLACE FUNCTION add(a INTEGER, b INTEGER) RETURNS INTEGER AS $$
        BEGIN
                RETURN a + b;
        END;
$$ LANGUAGE plpgsql;

SELECT add(5, 10);

--Example of using WITH ORDINALITY
SELECT s.i, s.x
FROM generate_series(1,3) WITH ORDINALITY AS s(x,i);