CREATE SCHEMA fuzz_schema;
SET search_path = fuzz_schema;

CREATE TABLE fuzz_tbl1 (
    id SERIAL PRIMARY KEY,
    data TEXT,
    num INTEGER
);

CREATE TABLE fuzz_tbl2 (
    id SERIAL PRIMARY KEY,
    ref_id INTEGER REFERENCES fuzz_tbl1(id),
    value NUMERIC(10, 2)
);

CREATE TABLE fuzz_tbl3 (
    ts TIMESTAMP WITH TIME ZONE,
    val JSONB
);

CREATE INDEX idx_fuzz_tbl2_ref_id ON fuzz_tbl2 (ref_id);

-- Insert data into fuzz_tbl1
INSERT INTO fuzz_tbl1 (data, num) VALUES
('test data 1', 10),
('test data 2', 20),
('test data 3', 30);

-- Insert data into fuzz_tbl2
INSERT INTO fuzz_tbl2 (ref_id, value) VALUES
(1, 123.45),
(2, 456.78),
(3, 789.01);

-- Insert data into fuzz_tbl3
INSERT INTO fuzz_tbl3 (ts, val) VALUES
(NOW(), '{"key1": "value1", "key2": 123}'),
(NOW() - INTERVAL '1 day', '{"key3": "value3", "key4": true}');

-- Select statements with different conditions
SELECT * FROM fuzz_tbl1 WHERE num > 15;
SELECT data FROM fuzz_tbl1 WHERE id = 1;
SELECT AVG(value) FROM fuzz_tbl2;
SELECT * FROM fuzz_tbl3 WHERE ts > NOW() - INTERVAL '2 days';
SELECT val ->> 'key1' FROM fuzz_tbl3;

-- Update statements
UPDATE fuzz_tbl1 SET data = 'updated data' WHERE id = 1;
UPDATE fuzz_tbl2 SET value = value * 1.1;

-- Delete statements
DELETE FROM fuzz_tbl1 WHERE num < 15;

-- Join operation
SELECT f1.data, f2.value
FROM fuzz_tbl1 f1
JOIN fuzz_tbl2 f2 ON f1.id = f2.ref_id;

-- Subquery
SELECT * FROM fuzz_tbl1 WHERE id IN (SELECT ref_id FROM fuzz_tbl2 WHERE value > 500);

-- Aggregate functions
SELECT COUNT(*) FROM fuzz_tbl1;
SELECT MAX(value) FROM fuzz_tbl2;
SELECT SUM(num) FROM fuzz_tbl1;
SELECT MIN(ts) FROM fuzz_tbl3;

-- Group by
SELECT ref_id, AVG(value) FROM fuzz_tbl2 GROUP BY ref_id;

-- Order by
SELECT * FROM fuzz_tbl1 ORDER BY num DESC;

-- Limit and Offset
SELECT * FROM fuzz_tbl1 LIMIT 2 OFFSET 1;

-- Case statement
SELECT
    id,
    CASE
        WHEN num > 25 THEN 'High'
        WHEN num > 15 THEN 'Medium'
        ELSE 'Low'
    END AS category
FROM fuzz_tbl1;

-- Window function
SELECT
    id,
    num,
    RANK() OVER (ORDER BY num DESC) AS rank
FROM fuzz_tbl1;

-- Common Table Expression (CTE)
WITH RankedData AS (
    SELECT
        id,
        num,
        RANK() OVER (ORDER BY num DESC) AS rank
    FROM fuzz_tbl1
)
SELECT * FROM RankedData WHERE rank <= 2;

-- Create a view
CREATE VIEW fuzz_view AS
SELECT f1.data, f2.value
FROM fuzz_tbl1 f1
JOIN fuzz_tbl2 f2 ON f1.id = f2.ref_id
WHERE f2.value > 200;

-- Select from the view
SELECT * FROM fuzz_view;

-- Materialized view
CREATE MATERIALIZED VIEW fuzz_materialized_view AS
SELECT f1.data, f2.value
FROM fuzz_tbl1 f1
JOIN fuzz_tbl2 f2 ON f1.id = f2.ref_id
WHERE f2.value > 200;

SELECT * from fuzz_materialized_view;

REFRESH MATERIALIZED VIEW fuzz_materialized_view;

-- Functions
CREATE FUNCTION add_one(i INTEGER) RETURNS INTEGER AS $$
        BEGIN
                RETURN i + 1;
        END;
$$ LANGUAGE plpgsql;

SELECT add_one(5);

CREATE OR REPLACE FUNCTION get_data(id_val INTEGER) RETURNS TEXT AS $$
BEGIN
    RETURN (SELECT data FROM fuzz_tbl1 WHERE id = id_val);
END;
$$ LANGUAGE plpgsql;

SELECT get_data(1);

-- Triggers

CREATE OR REPLACE FUNCTION audit_fuzz_tbl1()
RETURNS TRIGGER AS $$
BEGIN
    RAISE NOTICE 'Someone changed fuzz_tbl1!';
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER fuzz_tbl1_audit
AFTER UPDATE OR INSERT OR DELETE ON fuzz_tbl1
FOR EACH ROW
EXECUTE FUNCTION audit_fuzz_tbl1();

INSERT INTO fuzz_tbl1 (data, num) VALUES ('trigger test', 50);
UPDATE fuzz_tbl1 SET data = 'trigger update' WHERE id = 4;
DELETE FROM fuzz_tbl1 WHERE id = 4;

-- Check constraint
ALTER TABLE fuzz_tbl1 ADD CONSTRAINT num_positive CHECK (num > 0);

INSERT INTO fuzz_tbl1 (data, num) VALUES ('check constraint test', -1); -- will error

-- Foreign Key Constraint
INSERT INTO fuzz_tbl2 (ref_id, value) VALUES (999, 100.00); -- will error

-- Unique Constraint
ALTER TABLE fuzz_tbl1 ADD CONSTRAINT unique_data UNIQUE (data);

INSERT INTO fuzz_tbl1 (data, num) VALUES ('check constraint test', 50); -- will error if the data already exists

-- Transaction
BEGIN;
INSERT INTO fuzz_tbl1 (data, num) VALUES ('transaction test', 60);
UPDATE fuzz_tbl2 SET value = 999.99 WHERE ref_id = 1;
COMMIT;

BEGIN;
DELETE FROM fuzz_tbl1 WHERE id = 5;
ROLLBACK;

-- Sequences
CREATE SEQUENCE my_sequence START WITH 100 INCREMENT BY 5;
SELECT nextval('my_sequence');

-- Drop objects
DROP VIEW fuzz_view;
DROP MATERIALIZED VIEW fuzz_materialized_view;
DROP FUNCTION add_one(INTEGER);
DROP FUNCTION get_data(INTEGER);
DROP TRIGGER fuzz_tbl1_audit ON fuzz_tbl1;
DROP FUNCTION audit_fuzz_tbl1();
ALTER TABLE fuzz_tbl1 DROP CONSTRAINT IF EXISTS num_positive;
ALTER TABLE fuzz_tbl1 DROP CONSTRAINT IF EXISTS unique_data;
DROP SEQUENCE my_sequence;
DROP TABLE fuzz_tbl2;
DROP TABLE fuzz_tbl1;
DROP TABLE fuzz_tbl3;

DROP SCHEMA fuzz_schema;

RESET search_path;