CREATE EXTENSION IF NOT EXISTS citext;

CREATE UNLOGGED TABLE measurements (
    logdate         date not null,
    peaktemp        int,
    unitsales       int
);

CREATE TABLE products (
    product_no integer UNIQUE NOT NULL,
    name text,
    price numeric CHECK (price > 0)
);

CREATE TABLE orders (
    order_id integer PRIMARY KEY,
    customer_id integer NOT NULL,
    order_date date
);

CREATE TABLE order_items (
    item_id integer PRIMARY KEY,
    order_id integer REFERENCES orders(order_id),
    product_no integer REFERENCES products(product_no),
    quantity integer
);

INSERT INTO products (product_no, name, price) VALUES
    (1, 'Cheese', 9.99),
    (2, 'Bread', 2.50),
    (3, 'Milk', 3.00);

INSERT INTO orders (order_id, customer_id, order_date) VALUES
    (101, 1, '2024-01-01'),
    (102, 2, '2024-01-05');

INSERT INTO order_items (item_id, order_id, product_no, quantity) VALUES
    (1, 101, 1, 2),
    (2, 101, 2, 1),
    (3, 102, 3, 3);

CREATE TABLE employees (
    emp_id integer PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    emp_name text NOT NULL
);

INSERT INTO employees (emp_name) VALUES ('Alice'), ('Bob');

CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO users (username, email) VALUES
('john_doe', 'john.doe@example.com')
ON CONFLICT (username) DO NOTHING;

CREATE INDEX idx_username ON users (username);

CREATE VIEW recent_orders AS
SELECT order_id, customer_id, order_date
FROM orders
WHERE order_date > CURRENT_DATE - INTERVAL '30 days';

CREATE MATERIALIZED VIEW product_summary AS
SELECT product_no, SUM(quantity) AS total_quantity
FROM order_items
GROUP BY product_no;

REFRESH MATERIALIZED VIEW product_summary;

CREATE OR REPLACE FUNCTION get_product_price(product_id integer)
RETURNS numeric AS $$
BEGIN
  RETURN (SELECT price FROM products WHERE product_no = product_id);
END;
$$ LANGUAGE plpgsql;

SELECT get_product_price(1);

ALTER TABLE products ADD COLUMN description text;

UPDATE products SET description = 'Delicious cheese' WHERE product_no = 1;

DELETE FROM products WHERE product_no = 3;

DROP VIEW IF EXISTS recent_orders;