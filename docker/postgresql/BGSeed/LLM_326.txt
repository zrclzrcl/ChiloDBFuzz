CREATE TABLE employees (
    employee_id SERIAL PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone_number VARCHAR(20),
    hire_date DATE NOT NULL,
    job_id INTEGER,
    salary DECIMAL(10, 2),
    commission_pct DECIMAL(2, 2),
    manager_id INTEGER,
    department_id INTEGER
);

CREATE TABLE departments (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(50) NOT NULL,
    manager_id INTEGER,
    location_id INTEGER
);

CREATE TABLE jobs (
    job_id SERIAL PRIMARY KEY,
    job_title VARCHAR(50) NOT NULL,
    min_salary DECIMAL(10, 2),
    max_salary DECIMAL(10, 2)
);

ALTER TABLE employees ADD CONSTRAINT fk_employees_departments FOREIGN KEY (department_id) REFERENCES departments (department_id);
ALTER TABLE employees ADD CONSTRAINT fk_employees_jobs FOREIGN KEY (job_id) REFERENCES jobs (job_id);
ALTER TABLE departments ADD COLUMN description TEXT;

INSERT INTO jobs (job_title, min_salary, max_salary) VALUES
('Software Engineer', 60000.00, 150000.00),
('Data Scientist', 70000.00, 160000.00),
('Project Manager', 80000.00, 180000.00);

INSERT INTO departments (department_name, manager_id, location_id, description) VALUES
('Engineering', 1, 101, 'Responsible for software development'),
('Data Science', 2, 102, 'Focuses on data analysis and machine learning'),
('Management', 3, 103, 'Oversees project execution');

INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES
('John', 'Doe', 'john.doe@example.com', '2023-01-15', 1, 120000.00, 1),
('Jane', 'Smith', 'jane.smith@example.com', '2023-02-20', 2, 130000.00, 2),
('Peter', 'Jones', 'peter.jones@example.com', '2023-03-10', 3, 150000.00, 3);

SELECT * FROM employees WHERE salary > 100000 ORDER BY last_name;

UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;

DELETE FROM departments WHERE department_name = 'Management';

CREATE INDEX idx_last_name ON employees (last_name);

-- Using PostgreSQL specific features:
CREATE OR REPLACE FUNCTION calculate_bonus(salary DECIMAL, bonus_percentage DECIMAL)
RETURNS DECIMAL AS $$
BEGIN
  RETURN salary * bonus_percentage;
END;
$$ LANGUAGE plpgsql;

SELECT calculate_bonus(salary, 0.10) FROM employees;

-- Using a CTE
WITH EmployeeSalaries AS (
    SELECT first_name, last_name, salary
    FROM employees
    WHERE department_id = 1
)
SELECT first_name, last_name, salary
FROM EmployeeSalaries
WHERE salary > 120000;

-- Using window functions
SELECT
    first_name,
    last_name,
    salary,
    RANK() OVER (ORDER BY salary DESC) as salary_rank
FROM
    employees;

-- Using generate_series to create some additional dummy data
CREATE TABLE series_test (value INTEGER);
INSERT INTO series_test (value) SELECT generate_series(1, 10);
SELECT * FROM series_test;

DROP TABLE series_test;

-- Check constraints
ALTER TABLE employees ADD CONSTRAINT salary_check CHECK (salary > 0);

-- Materialized View
CREATE MATERIALIZED VIEW high_earners AS
SELECT employee_id, first_name, last_name, salary
FROM employees
WHERE salary > 100000;

REFRESH MATERIALIZED VIEW high_earners;

SELECT * FROM high_earners;

DROP MATERIALIZED VIEW high_earners;