CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE products (
    product_id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL CHECK (price > 0),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    order_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    total_amount DECIMAL(10, 2)
);

CREATE TABLE order_items (
    order_item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(order_id),
    product_id UUID REFERENCES products(product_id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price DECIMAL(10, 2)
);

INSERT INTO users (username, email) VALUES
('john_doe', 'john.doe@example.com'),
('jane_smith', 'jane.smith@example.com');

INSERT INTO products (name, description, price) VALUES
('Awesome T-Shirt', 'A really cool t-shirt', 25.00),
('Fantastic Mug', 'A mug for fantastic people', 12.50);

INSERT INTO orders (user_id, total_amount) VALUES
(1, 37.50);

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
(1, (SELECT product_id FROM products WHERE name = 'Awesome T-Shirt'), 1, 25.00),
(1, (SELECT product_id FROM products WHERE name = 'Fantastic Mug'), 1, 12.50);

SELECT * FROM users WHERE username = 'john_doe';

UPDATE products SET price = 27.50 WHERE name = 'Awesome T-Shirt';

DELETE FROM order_items WHERE order_id = 1 AND product_id = (SELECT product_id FROM products WHERE name = 'Fantastic Mug');

ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT TRUE;

CREATE INDEX idx_users_username ON users (username);

-- Example using jsonb
CREATE TABLE product_details (
    product_id UUID REFERENCES products(product_id),
    details jsonb
);

INSERT INTO product_details (product_id, details)
VALUES ((SELECT product_id FROM products WHERE name = 'Awesome T-Shirt'), '{"color": "blue", "size": "L"}');

SELECT details->>'color' FROM product_details WHERE product_id = (SELECT product_id FROM products WHERE name = 'Awesome T-Shirt');

-- Example using WITH clause (CTE)
WITH high_value_products AS (
    SELECT product_id, name, price
    FROM products
    WHERE price > 20
)
SELECT o.order_id, u.username, h.name, h.price
FROM orders o
JOIN users u ON o.user_id = u.id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN high_value_products h ON oi.product_id = h.product_id;