CREATE TABLE employees (
    employee_id SERIAL PRIMARY KEY,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    hire_date DATE,
    salary DECIMAL(10, 2)
);

CREATE TABLE departments (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(50),
    manager_id INTEGER REFERENCES employees(employee_id) ON DELETE SET NULL
);

ALTER TABLE employees ADD COLUMN department_id INTEGER REFERENCES departments(department_id) ON DELETE SET NULL;

INSERT INTO employees (first_name, last_name, hire_date, salary, department_id) VALUES
('John', 'Doe', '2020-01-15', 60000.00, NULL),
('Jane', 'Smith', '2021-03-20', 75000.00, NULL),
('Peter', 'Jones', '2022-05-10', 55000.00, NULL);

INSERT INTO departments (department_name, manager_id) VALUES
('Sales', NULL),
('Marketing', NULL),
('Engineering', NULL);

UPDATE employees SET department_id = 1 WHERE employee_id = 1;
UPDATE employees SET department_id = 2 WHERE employee_id = 2;
UPDATE employees SET department_id = 3 WHERE employee_id = 3;

UPDATE departments SET manager_id = 1 WHERE department_id = 1;
UPDATE departments SET manager_id = 2 WHERE department_id = 2;
UPDATE departments SET manager_id = 3 WHERE department_id = 3;

SELECT * FROM employees;
SELECT * FROM departments;

DELETE FROM departments WHERE department_id = 3;
SELECT * FROM employees;

UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;

SELECT first_name, last_name, salary FROM employees WHERE salary > 65000.00;

CREATE VIEW employee_details AS
SELECT e.first_name, e.last_name, d.department_name
FROM employees e
JOIN departments d ON e.department_id = d.department_id;

SELECT * FROM employee_details;

CREATE INDEX idx_last_name ON employees (last_name);

ANALYZE employees;
ANALYZE departments;

EXPLAIN SELECT * FROM employees WHERE last_name = 'Smith';

-- PostgreSQL specific features
CREATE TEMP TABLE temp_employees AS SELECT * FROM employees;
SELECT * FROM temp_employees;

CREATE OR REPLACE FUNCTION increment_salary(emp_id INTEGER, increment DECIMAL)
RETURNS VOID AS $$
BEGIN
    UPDATE employees SET salary = salary + increment WHERE employee_id = emp_id;
END;
$$ LANGUAGE plpgsql;

SELECT increment_salary(1, 5000.00);
SELECT * FROM employees WHERE employee_id = 1;

DROP FUNCTION increment_salary(INTEGER, DECIMAL);
DROP VIEW employee_details;
DROP INDEX idx_last_name;
DROP TABLE temp_employees;
DROP TABLE employees CASCADE;
DROP TABLE departments CASCADE;