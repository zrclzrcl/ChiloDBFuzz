\echo Use "psql -f <this_file>" to load this file.
\quit

-- DDL statements
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    salary DECIMAL(10, 2),
    hire_date DATE,
    data jsonb
);

CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    location VARCHAR(100)
);

CREATE TABLE employee_department (
    employee_id INTEGER REFERENCES employees(id),
    department_id INTEGER REFERENCES departments(id),
    PRIMARY KEY (employee_id, department_id)
);

CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');

CREATE TABLE mood_log (
    id SERIAL PRIMARY KEY,
    employee_id INTEGER REFERENCES employees(id),
    mood_value mood,
    log_time TIMESTAMP WITHOUT TIME ZONE DEFAULT (now() at time zone 'utc')
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(100),
    order_date DATE DEFAULT CURRENT_DATE,
    total_amount DECIMAL(12,2)
);

CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(order_id),
    product_name VARCHAR(255),
    quantity INTEGER,
    unit_price DECIMAL(10,2)
);

CREATE TABLE products (
  product_id SERIAL PRIMARY KEY,
  product_name VARCHAR(255) NOT NULL,
  description TEXT,
  price DECIMAL(10,2)
);

CREATE MATERIALIZED VIEW monthly_sales AS
SELECT
    EXTRACT(YEAR FROM order_date) AS sale_year,
    EXTRACT(MONTH FROM order_date) AS sale_month,
    SUM(total_amount) AS total_sales
FROM orders
GROUP BY sale_year, sale_month
ORDER BY sale_year, sale_month;

-- DML statements
INSERT INTO departments (name, location) VALUES ('Sales', 'New York');
INSERT INTO departments (name, location) VALUES ('Marketing', 'London');
INSERT INTO departments (name, location) VALUES ('Engineering', 'San Francisco');

INSERT INTO employees (name, salary, hire_date, data) VALUES ('Alice', 60000, '2023-01-15', '{"age": 30, "city": "New York"}');
INSERT INTO employees (name, salary, hire_date, data) VALUES ('Bob', 75000, '2022-05-20', '{"age": 35, "city": "London"}');
INSERT INTO employees (name, salary, hire_date, data) VALUES ('Charlie', 90000, '2023-03-10', '{"age": 40, "city": "San Francisco"}');

INSERT INTO employee_department (employee_id, department_id) VALUES (1, 1);
INSERT INTO employee_department (employee_id, department_id) VALUES (2, 2);
INSERT INTO employee_department (employee_id, department_id) VALUES (3, 3);

INSERT INTO orders (customer_name, order_date, total_amount) VALUES ('David', '2024-01-05', 150.00);
INSERT INTO orders (customer_name, order_date, total_amount) VALUES ('Eve', '2024-01-10', 200.00);
INSERT INTO orders (customer_name, order_date, total_amount) VALUES ('Fred', '2024-02-15', 300.00);

INSERT INTO order_items (order_id, product_name, quantity, unit_price) VALUES (1, 'Laptop', 1, 1200.00);
INSERT INTO order_items (order_id, product_name, quantity, unit_price) VALUES (1, 'Mouse', 1, 20.00);
INSERT INTO order_items (order_id, product_name, quantity, unit_price) VALUES (2, 'Keyboard', 1, 75.00);

-- Function and trigger examples

CREATE FUNCTION calculate_bonus(emp_id INTEGER) RETURNS DECIMAL AS $$
DECLARE
    bonus DECIMAL;
    emp_salary DECIMAL;
BEGIN
    SELECT salary INTO emp_salary FROM employees WHERE id = emp_id;
    bonus := emp_salary * 0.10;
    RETURN bonus;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION refresh_monthly_sales()
RETURNS TRIGGER AS $$
BEGIN
  REFRESH MATERIALIZED VIEW monthly_sales;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER order_inserted
AFTER INSERT ON orders
FOR EACH ROW
EXECUTE FUNCTION refresh_monthly_sales();

--Add check constraint
ALTER TABLE employees ADD CONSTRAINT salary_positive CHECK (salary > 0);

-- Complex Queries:
SELECT e.name, d.name AS department FROM employees e JOIN employee_department ed ON e.id = ed.employee_id JOIN departments d ON ed.department_id = d.id WHERE e.salary > 70000;

SELECT product_name, SUM(quantity * unit_price) AS total_revenue FROM order_items GROUP BY product_name ORDER BY total_revenue DESC;

SELECT customer_name, SUM(total_amount) AS total_spent FROM orders GROUP BY customer_name HAVING SUM(total_amount) > 250 ORDER BY total_spent DESC;

-- JSONB operations
UPDATE employees SET data = jsonb_set(data, '{address}', '"123 Main St"') WHERE id = 1;
SELECT name, data -> 'address' FROM employees WHERE data ? 'address';

-- Partitioning
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    region TEXT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL
) PARTITION BY RANGE (sale_date);

CREATE TABLE sales_y2023m01 PARTITION OF sales
    FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');

CREATE TABLE sales_y2023m02 PARTITION OF sales
    FOR VALUES FROM ('2023-02-01') TO ('2023-03-01');

INSERT INTO sales (sale_date, region, amount) VALUES ('2023-01-15', 'North', 100.00);
INSERT INTO sales (sale_date, region, amount) VALUES ('2023-02-20', 'South', 150.00);

-- Cleanup (optional, but good practice for a seed)
DROP TABLE IF EXISTS sales_y2023m01;
DROP TABLE IF EXISTS sales_y2023m02;
DROP TABLE IF EXISTS sales;

DROP TRIGGER IF EXISTS order_inserted ON orders;
DROP FUNCTION IF EXISTS refresh_monthly_sales();
DROP FUNCTION IF EXISTS calculate_bonus(INTEGER);
DROP MATERIALIZED VIEW IF EXISTS monthly_sales;
DROP TABLE IF EXISTS employee_department;
DROP TABLE IF EXISTS employees;
DROP TABLE IF EXISTS departments;
DROP TABLE IF EXISTS mood_log;
DROP TABLE IF EXISTS orders;
DROP TABLE IF EXISTS order_items;
DROP TABLE IF EXISTS products;
DROP TYPE IF EXISTS mood;