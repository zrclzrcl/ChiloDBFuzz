CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INTEGER NOT NULL,
    order_date DATE NOT NULL,
    total_amount DECIMAL(10, 2)
);

CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone_number VARCHAR(20)
);

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL
);

CREATE TABLE order_items (
    order_item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(order_id),
    product_id INTEGER REFERENCES products(product_id),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL
);

INSERT INTO customers (first_name, last_name, email, phone_number) VALUES
('John', 'Doe', 'john.doe@example.com', '555-123-4567'),
('Jane', 'Smith', 'jane.smith@example.com', '555-987-6543');

INSERT INTO products (product_name, description, price) VALUES
('Laptop', 'High-performance laptop', 1200.00),
('Mouse', 'Wireless mouse', 25.00),
('Keyboard', 'Mechanical keyboard', 75.00);

INSERT INTO orders (customer_id, order_date, total_amount) VALUES
(1, '2024-01-15', 1225.00),
(2, '2024-01-20', 100.00);

INSERT INTO order_items (order_id, product_id, quantity, unit_price) VALUES
(1, 1, 1, 1200.00),
(1, 2, 1, 25.00),
(2, 2, 2, 25.00),
(2, 3, 1, 50.00);

SELECT * FROM customers WHERE last_name = 'Doe';

UPDATE products SET price = 1300.00 WHERE product_name = 'Laptop';

DELETE FROM order_items WHERE order_id = 2 AND product_id = 3;

SELECT o.order_id, c.first_name, c.last_name, o.order_date, o.total_amount
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= '2024-01-01';

SELECT p.product_name, SUM(oi.quantity) AS total_quantity_sold
FROM products p
JOIN order_items oi ON p.product_id = oi.product_id
GROUP BY p.product_name
ORDER BY total_quantity_sold DESC;

CREATE INDEX idx_customer_last_name ON customers (last_name);

EXPLAIN SELECT * FROM customers WHERE last_name = 'Smith';

-- Using window functions
SELECT
    order_id,
    order_date,
    total_amount,
    AVG(total_amount) OVER () AS average_order_value
FROM orders;

-- Using Common Table Expressions (CTEs)
WITH high_value_customers AS (
    SELECT customer_id
    FROM orders
    GROUP BY customer_id
    HAVING SUM(total_amount) > 1000
)
SELECT c.first_name, c.last_name
FROM customers c
JOIN high_value_customers hvc ON c.customer_id = hvc.customer_id;

-- Using subqueries
SELECT product_name
FROM products
WHERE price > (SELECT AVG(price) FROM products);

-- Using DISTINCT
SELECT DISTINCT customer_id FROM orders;

-- Using CASE statements
SELECT
    order_id,
    CASE
        WHEN total_amount > 1000 THEN 'High Value'
        ELSE 'Normal Value'
    END AS order_value_category
FROM orders;

-- Try JSON functions
SELECT json_build_object('customer_id', customer_id, 'name', first_name || ' ' || last_name) FROM customers;

-- Using GENERATE_SERIES
SELECT generate_series(1, 10);

-- Trigger example
CREATE OR REPLACE FUNCTION update_order_total()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE orders SET total_amount = (SELECT SUM(quantity * unit_price) FROM order_items WHERE order_id = NEW.order_id) WHERE order_id = NEW.order_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER order_items_insert
AFTER INSERT ON order_items
FOR EACH ROW
EXECUTE FUNCTION update_order_total();

-- Insert after trigger creation
INSERT INTO order_items (order_id, product_id, quantity, unit_price) VALUES (1, 3, 2, 75.00);

-- Cleanup objects
DROP TRIGGER IF EXISTS order_items_insert ON order_items;
DROP FUNCTION IF EXISTS update_order_total();

DROP INDEX idx_customer_last_name;
DROP TABLE order_items;
DROP TABLE orders;
DROP TABLE products;
DROP TABLE customers;