DROP TABLE IF EXISTS employees CASCADE;
DROP TABLE IF EXISTS departments CASCADE;
DROP SEQUENCE IF EXISTS employee_id_seq CASCADE;
DROP TYPE IF EXISTS mood CASCADE;
DROP FUNCTION IF EXISTS increment CASCADE;
DROP VIEW IF EXISTS employee_department CASCADE;

-- Create an ENUM type
CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');

-- Create sequence
CREATE SEQUENCE employee_id_seq START WITH 1 INCREMENT BY 1;

-- Create Tables
CREATE TABLE departments (
    dept_id SERIAL PRIMARY KEY,
    dept_name VARCHAR(50) NOT NULL
);

CREATE TABLE employees (
    employee_id INTEGER PRIMARY KEY DEFAULT nextval('employee_id_seq'),
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    salary DECIMAL(10, 2) NOT NULL,
    dept_id INTEGER REFERENCES departments(dept_id),
    hire_date DATE NOT NULL,
    mood_state mood
);

-- Insert Data
INSERT INTO departments (dept_name) VALUES ('Sales');
INSERT INTO departments (dept_name) VALUES ('Marketing');
INSERT INTO departments (dept_name) VALUES ('Engineering');

INSERT INTO employees (first_name, last_name, salary, dept_id, hire_date, mood_state) VALUES ('John', 'Doe', 60000.00, 1, '2022-01-15', 'happy');
INSERT INTO employees (first_name, last_name, salary, dept_id, hire_date, mood_state) VALUES ('Jane', 'Smith', 75000.00, 2, '2021-05-20', 'ok');
INSERT INTO employees (first_name, last_name, salary, dept_id, hire_date, mood_state) VALUES ('Peter', 'Jones', 90000.00, 3, '2020-11-01', 'sad');
INSERT INTO employees (first_name, last_name, salary, dept_id, hire_date, mood_state) VALUES ('Alice', 'Brown', 80000.00, 3, '2023-03-10', 'happy');

-- Basic SELECT statement
SELECT * FROM employees;

-- SELECT with WHERE clause
SELECT * FROM employees WHERE salary > 70000.00;

-- SELECT with JOIN
SELECT e.first_name, e.last_name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;

-- SELECT with GROUP BY and aggregate function
SELECT dept_id, AVG(salary) AS average_salary
FROM employees
GROUP BY dept_id;

-- SELECT with ORDER BY and LIMIT
SELECT * FROM employees ORDER BY salary DESC LIMIT 2;

-- UPDATE statement
UPDATE employees SET salary = 65000.00 WHERE employee_id = 1;

-- DELETE statement
DELETE FROM employees WHERE employee_id = 4;

-- Create Index
CREATE INDEX idx_employee_last_name ON employees (last_name);

-- Alter Table
ALTER TABLE employees ADD COLUMN email VARCHAR(100);

-- Update email addresses
UPDATE employees SET email = LOWER(first_name) || '.' || LOWER(last_name) || '@example.com';

-- Create View
CREATE VIEW employee_department AS
SELECT e.first_name, e.last_name, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.dept_id;

-- Select from View
SELECT * FROM employee_department;

-- Create a PL/pgSQL function
CREATE OR REPLACE FUNCTION increment(i INTEGER) RETURNS INTEGER AS $$
BEGIN
    RETURN i + 1;
END;
$$ LANGUAGE plpgsql;

-- Use the function
SELECT increment(5);

-- More inserts after updates and deletes
INSERT INTO employees (first_name, last_name, salary, dept_id, hire_date, mood_state) VALUES ('Eve', 'Williams', 72000.00, 1, '2024-04-01', 'ok');
INSERT INTO employees (first_name, last_name, salary, dept_id, hire_date, mood_state) VALUES ('Bob', 'Johnson', 88000.00, 2, '2023-09-15', 'sad');

-- Table Partitioning example
DROP TABLE IF EXISTS measurement;
CREATE TABLE measurement (
    logdate date NOT NULL,
    peaktemp int,
    unitsales int
) PARTITION BY RANGE (logdate);

CREATE TABLE measurement_y2006m02 PARTITION OF measurement
    FOR VALUES FROM ('2006-02-01') TO ('2006-03-01');

CREATE TABLE measurement_y2006m03 PARTITION OF measurement
    FOR VALUES FROM ('2006-03-01') TO ('2006-04-01');

-- Insert into partitioned table
INSERT INTO measurement (logdate, peaktemp, unitsales) VALUES ('2006-02-14', 50, 100);
INSERT INTO measurement (logdate, peaktemp, unitsales) VALUES ('2006-03-21', 60, 120);

-- JSONB example
DROP TABLE IF EXISTS products;
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    details JSONB
);

INSERT INTO products (name, details) VALUES ('Laptop', '{"brand": "Dell", "model": "XPS 13", "specs": {"cpu": "i7", "ram": "16GB"}}');

SELECT name, details -> 'brand' AS brand FROM products;
SELECT name, details -> 'specs' -> 'cpu' AS cpu FROM products;

-- Concurrent Index creation
CREATE INDEX CONCURRENTLY idx_products_name ON products (name);

-- pg_sleep
SELECT pg_sleep(1);

-- Create Extension pg_stat_statements if not exists
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
SELECT pg_stat_statements_reset();
SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;

-- Example using uuid
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
SELECT uuid_generate_v4();

SELECT pg_switch_wal();