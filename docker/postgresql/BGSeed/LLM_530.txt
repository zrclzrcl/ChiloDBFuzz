CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    order_date TIMESTAMPTZ DEFAULT NOW(),
    total_amount DECIMAL(12, 2)
);

CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(order_id),
    product_id INTEGER REFERENCES products(product_id),
    quantity INTEGER,
    price DECIMAL(10, 2)
);

INSERT INTO users (username, email) VALUES
('john_doe', 'john.doe@example.com'),
('jane_smith', 'jane.smith@example.com'),
('peter_jones', 'peter.jones@example.com');

INSERT INTO products (name, description, price) VALUES
('Laptop', 'High-performance laptop', 1200.00),
('Mouse', 'Wireless mouse', 25.00),
('Keyboard', 'Mechanical keyboard', 75.00);

INSERT INTO orders (user_id, total_amount) VALUES
(1, 1225.00),
(2, 150.00),
(3, 75.00);

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
(1, 1, 1, 1200.00),
(1, 2, 1, 25.00),
(2, 2, 2, 25.00),
(2, 3, 1, 75.00),
(3, 3, 1, 75.00);

SELECT * FROM users WHERE username = 'john_doe';

UPDATE products SET price = 1300.00 WHERE name = 'Laptop';

DELETE FROM order_items WHERE order_id = 3;

SELECT o.order_id, u.username, p.name, oi.quantity
FROM orders o
JOIN users u ON o.user_id = u.id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id;

SELECT AVG(price) FROM products;

SELECT user_id, SUM(total_amount) AS total_spent FROM orders GROUP BY user_id ORDER BY total_spent DESC;

SELECT generate_series(1, 10);

SELECT string_agg(username, ', ') FROM users;

CREATE TABLE json_test (
  id SERIAL PRIMARY KEY,
  data jsonb
);

INSERT INTO json_test (data) VALUES
('{"name": "test", "value": 123}');

SELECT data ->> 'name' FROM json_test;

SELECT gen_random_uuid();

-- CTE example
WITH UserOrderTotals AS (
  SELECT
    u.username,
    SUM(o.total_amount) AS total_spent
  FROM
    users u
  JOIN
    orders o ON u.id = o.user_id
  GROUP BY
    u.username
)
SELECT
  username,
  total_spent
FROM
  UserOrderTotals
ORDER BY
  total_spent DESC;