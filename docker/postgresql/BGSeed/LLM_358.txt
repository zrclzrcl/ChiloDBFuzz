CREATE TABLE employees (
    employee_id SERIAL PRIMARY KEY,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    email VARCHAR(100) UNIQUE,
    phone_number VARCHAR(20),
    hire_date DATE,
    job_id INTEGER,
    salary DECIMAL(10, 2),
    commission_pct DECIMAL(4, 2),
    manager_id INTEGER,
    department_id INTEGER
);

CREATE TABLE departments (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(50),
    location_id INTEGER
);

CREATE TABLE jobs (
    job_id SERIAL PRIMARY KEY,
    job_title VARCHAR(50),
    min_salary DECIMAL(10, 2),
    max_salary DECIMAL(10, 2)
);

CREATE TABLE locations (
    location_id SERIAL PRIMARY KEY,
    address VARCHAR(100),
    postal_code VARCHAR(20),
    city VARCHAR(50),
    state_province VARCHAR(50),
    country_id VARCHAR(2)
);

CREATE TABLE countries (
    country_id VARCHAR(2) PRIMARY KEY,
    country_name VARCHAR(50),
    region_id INTEGER
);

CREATE TABLE regions (
    region_id SERIAL PRIMARY KEY,
    region_name VARCHAR(50)
);

ALTER TABLE employees ADD CONSTRAINT fk_employees_departments FOREIGN KEY (department_id) REFERENCES departments (department_id);
ALTER TABLE employees ADD CONSTRAINT fk_employees_jobs FOREIGN KEY (job_id) REFERENCES jobs (job_id);
ALTER TABLE departments ADD CONSTRAINT fk_departments_locations FOREIGN KEY (location_id) REFERENCES locations (location_id);
ALTER TABLE locations ADD CONSTRAINT fk_locations_countries FOREIGN KEY (country_id) REFERENCES countries (country_id);
ALTER TABLE countries ADD CONSTRAINT fk_countries_regions FOREIGN KEY (region_id) REFERENCES regions (region_id);

INSERT INTO regions (region_name) VALUES ('Europe');
INSERT INTO countries (country_id, country_name, region_id) VALUES ('US', 'United States', 1);
INSERT INTO locations (address, postal_code, city, state_province, country_id) VALUES ('123 Main St', '12345', 'Anytown', 'CA', 'US');
INSERT INTO departments (department_name, location_id) VALUES ('Sales', 1);
INSERT INTO jobs (job_title, min_salary, max_salary) VALUES ('Sales Representative', 50000.00, 100000.00);
INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES ('John', 'Doe', 'john.doe@example.com', '2023-01-01', 1, 60000.00, 1);
INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES ('Jane', 'Smith', 'jane.smith@example.com', '2023-02-15', 1, 70000.00, 1);

SELECT * FROM employees WHERE salary > 65000;
UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;
DELETE FROM employees WHERE employee_id = 2;

CREATE INDEX idx_employees_last_name ON employees (last_name);
DROP INDEX idx_employees_last_name;

SELECT department_name, COUNT(*) FROM employees e JOIN departments d ON e.department_id = d.department_id GROUP BY department_name;
SELECT first_name, last_name FROM employees ORDER BY salary DESC LIMIT 5;

CREATE VIEW high_earners AS SELECT first_name, last_name FROM employees WHERE salary > 80000;
SELECT * FROM high_earners;
DROP VIEW high_earners;

SELECT coalesce(phone_number, 'N/A') FROM employees;
SELECT nullif(first_name, 'John') FROM employees;
SELECT CASE WHEN salary > 75000 THEN 'High' ELSE 'Low' END FROM employees;

SELECT md5(email) FROM employees;
SELECT substring(first_name, 1, 3) FROM employees;

CREATE FUNCTION get_employee_count(dept_id INTEGER) RETURNS INTEGER AS $$
BEGIN
    RETURN (SELECT COUNT(*) FROM employees WHERE department_id = dept_id);
END;
$$ LANGUAGE plpgsql;

SELECT get_employee_count(1);
DROP FUNCTION get_employee_count(INTEGER);

SELECT CAST(hire_date AS TEXT) FROM employees;

CREATE TABLE test_table (
  id SERIAL PRIMARY KEY,
  json_data JSONB
);

INSERT INTO test_table (json_data) VALUES ('{"name": "Alice", "age": 30}');
SELECT jsonb_path_exists(json_data, '$.name') FROM test_table;

-- Concurrency Test
BEGIN;
UPDATE employees SET salary = salary * 1.05 WHERE employee_id = 1;
SELECT salary FROM employees WHERE employee_id = 1;
COMMIT;

-- Using WITH clause (Common Table Expression)
WITH avg_salary AS (
  SELECT AVG(salary) AS avg_sal FROM employees
)
SELECT first_name, last_name FROM employees WHERE salary > (SELECT avg_sal FROM avg_salary);

-- Generate series for date ranges
SELECT generate_series('2024-01-01'::date, '2024-01-10'::date, '1 day');

-- Window function example
SELECT
    first_name,
    last_name,
    salary,
    RANK() OVER (ORDER BY salary DESC) as salary_rank
FROM
    employees;

-- Table inheritance
CREATE TABLE person (
    name text,
    age integer
);

CREATE TABLE employee (
    salary integer
) INHERITS (person);

INSERT INTO person (name, age) VALUES ('Bob', 40);
INSERT INTO employee (name, age, salary) VALUES ('Charlie', 35, 80000);

SELECT * FROM person;
SELECT * FROM employee;