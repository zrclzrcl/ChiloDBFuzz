CREATE TABLE employees (
    employee_id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone_number VARCHAR(20),
    hire_date DATE NOT NULL,
    job_id INTEGER,
    salary DECIMAL(10, 2),
    commission_pct DECIMAL(4, 2),
    manager_id UUID,
    department_id INTEGER
);

CREATE TABLE departments (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(50) NOT NULL,
    manager_id UUID,
    location_id INTEGER
);

CREATE TABLE jobs (
    job_id SERIAL PRIMARY KEY,
    job_title VARCHAR(50) NOT NULL,
    min_salary DECIMAL(10, 2),
    max_salary DECIMAL(10, 2)
);

ALTER TABLE employees ADD CONSTRAINT fk_employees_departments FOREIGN KEY (department_id) REFERENCES departments(department_id);
ALTER TABLE employees ADD CONSTRAINT fk_employees_jobs FOREIGN KEY (job_id) REFERENCES jobs(job_id);
ALTER TABLE departments ADD CONSTRAINT fk_departments_employees FOREIGN KEY (manager_id) REFERENCES employees(employee_id);
ALTER TABLE employees ADD CONSTRAINT fk_employees_employees FOREIGN KEY (manager_id) REFERENCES employees(employee_id);

INSERT INTO jobs (job_title, min_salary, max_salary) VALUES
('Software Engineer', 60000, 150000),
('Data Scientist', 70000, 160000),
('Project Manager', 80000, 170000);

INSERT INTO departments (department_name) VALUES
('Engineering'),
('Data Science'),
('Management');

INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES
('John', 'Doe', 'john.doe@example.com', '2023-01-15', 1, 80000, 1),
('Jane', 'Smith', 'jane.smith@example.com', '2022-05-20', 2, 90000, 2),
('Peter', 'Jones', 'peter.jones@example.com', '2023-03-10', 3, 100000, 3);

UPDATE employees SET salary = 85000 WHERE first_name = 'John';

DELETE FROM employees WHERE first_name = 'Peter';

SELECT * FROM employees WHERE salary > 75000;

SELECT department_name, COUNT(*) FROM departments d JOIN employees e ON d.department_id = e.department_id GROUP BY department_name;

CREATE INDEX idx_employees_lastname ON employees (last_name);

CREATE VIEW high_salary_employees AS
SELECT first_name, last_name, salary FROM employees WHERE salary > 90000;

SELECT * FROM high_salary_employees;

-- Using JSONB Data type
ALTER TABLE departments ADD COLUMN details JSONB;
UPDATE departments SET details = '{"location": "New York", "size": 50}'::jsonb WHERE department_name = 'Engineering';
SELECT department_name, details -> 'location' FROM departments;

-- Using WITH RECURSIVE (Example:  Hierarchical data - not truly hierarchical in this case)
WITH RECURSIVE EmployeeHierarchy AS (
    SELECT employee_id, first_name, manager_id, 1 AS level
    FROM employees
    WHERE manager_id IS NULL

    UNION ALL

    SELECT e.employee_id, e.first_name, e.manager_id, eh.level + 1
    FROM employees e
    JOIN EmployeeHierarchy eh ON e.manager_id = eh.employee_id
)
SELECT * FROM EmployeeHierarchy;

-- Generated always as identity
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(100),
    price DECIMAL(10,2),
    discounted_price DECIMAL(10,2) GENERATED ALWAYS AS (price * 0.9) STORED
);

INSERT INTO products (product_name, price) VALUES ('Laptop', 1200);
SELECT * FROM products;

DROP VIEW IF EXISTS high_salary_employees;
DROP TABLE IF EXISTS employees;
DROP TABLE IF EXISTS departments;
DROP TABLE IF EXISTS jobs;
DROP TABLE IF EXISTS products;