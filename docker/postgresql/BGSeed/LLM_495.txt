CREATE TABLE customer (
    custid     SERIAL PRIMARY KEY,
    custname   VARCHAR(40) NOT NULL,
    city       VARCHAR(40)
);

CREATE TABLE item (
    itemid     SERIAL PRIMARY KEY,
    itemname   VARCHAR(40) NOT NULL,
    unitprice  NUMERIC(10,2) CHECK (unitprice > 0)
);

CREATE TABLE orders (
    orderid    SERIAL PRIMARY KEY,
    custid     INT REFERENCES customer (custid),
    orderdate  DATE NOT NULL
);

CREATE TABLE order_item (
    orderid    INT REFERENCES orders (orderid),
    itemid     INT REFERENCES item (itemid),
    quantity   INT NOT NULL CHECK (quantity > 0),
    PRIMARY KEY (orderid, itemid)
);

INSERT INTO customer (custname, city) VALUES
('John Smith', 'New York'),
('Alice Brown', 'Los Angeles'),
('Peter Jones', 'Chicago');

INSERT INTO item (itemname, unitprice) VALUES
('Laptop', 1200.00),
('Mouse', 25.00),
('Keyboard', 75.00);

INSERT INTO orders (custid, orderdate) VALUES
(1, '2024-01-15'),
(2, '2024-02-20'),
(3, '2024-03-10');

INSERT INTO order_item (orderid, itemid, quantity) VALUES
(1, 1, 1),
(1, 2, 2),
(2, 3, 1),
(3, 1, 1);

CREATE INDEX idx_custname ON customer (custname);
CREATE INDEX idx_itemname ON item (itemname);
CREATE INDEX idx_orderdate ON orders (orderdate);

SELECT * FROM customer WHERE city = 'New York';
SELECT itemname, unitprice FROM item WHERE unitprice > 50;
SELECT orderid, orderdate FROM orders WHERE orderdate BETWEEN '2024-01-01' AND '2024-02-28';
SELECT c.custname, o.orderid FROM customer c JOIN orders o ON c.custid = o.custid;
SELECT i.itemname, oi.quantity FROM item i JOIN order_item oi ON i.itemid = oi.itemid;

UPDATE item SET unitprice = 1300.00 WHERE itemname = 'Laptop';
DELETE FROM customer WHERE custname = 'Peter Jones';

SELECT COUNT(*) FROM customer;
SELECT AVG(unitprice) FROM item;
SELECT MAX(orderdate) FROM orders;
SELECT SUM(quantity) FROM order_item;

SELECT custname FROM customer ORDER BY custname ASC;
SELECT itemname FROM item ORDER BY unitprice DESC;

-- Test of PostgreSQL specific features
CREATE TEXT SEARCH DICTIONARY my_dict (
    TEMPLATE = snowball,
    Language = english
);
CREATE TEXT SEARCH CONFIGURATION my_config ( COPY = english );
ALTER TEXT SEARCH CONFIGURATION my_config ADD MAPPING FOR word, asciiword, hword_asciipart WITH my_dict;
SELECT ts_lexize('my_dict', 'skies');

SELECT pg_backend_pid();
SELECT pg_database_size('postgres');

CREATE OR REPLACE FUNCTION add_em(a integer, b integer) RETURNS integer AS $$
        BEGIN
                RETURN a + b;
        END;
$$ LANGUAGE plpgsql;

SELECT add_em(1, 2);

CREATE TABLE products (
    product_no integer,
    name text,
    price numeric
);

INSERT INTO products VALUES
    (1, 'Cheese', 9.99),
    (2, 'Bread', 1.49),
    (3, 'Milk', 2.99);

SELECT * FROM products WHERE price = (SELECT MAX(price) FROM products);

DROP FUNCTION add_em(integer, integer);

DROP TEXT SEARCH CONFIGURATION my_config;
DROP TEXT SEARCH DICTIONARY my_dict;
DROP TABLE order_item;
DROP TABLE orders;
DROP TABLE item;
DROP TABLE customer;