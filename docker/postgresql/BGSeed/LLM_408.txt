CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    attributes JSONB
);

INSERT INTO products (name, description, price, attributes) VALUES
('Laptop', 'High-performance laptop', 1200.00, '{"brand": "Dell", "processor": "Intel i7", "memory": "16GB"}'),
('Mouse', 'Wireless mouse', 25.00, '{"type": "optical", "connectivity": "wireless", "color": "black"}'),
('Keyboard', 'Ergonomic keyboard', 75.00, '{"type": "mechanical", "layout": "QWERTY", "backlit": true}'),
('Monitor', '27-inch curved monitor', 350.00, '{"size": 27, "resolution": "1920x1080", "refresh_rate": 144}');

SELECT * FROM products WHERE attributes @> '{"brand": "Dell"}';

SELECT * FROM products WHERE attributes ->> 'processor' = 'Intel i7';

UPDATE products SET attributes = jsonb_set(attributes, '{price}', '500.00') WHERE name = 'Monitor';

SELECT jsonb_pretty(attributes) FROM products;

SELECT jsonb_path_exists(attributes, '$.brand') FROM products WHERE name = 'Laptop';

CREATE INDEX idx_product_attributes ON products USING gin (attributes);

SELECT * FROM products WHERE attributes ? 'brand';

SELECT jsonb_array_elements( '[{"a":1, "b":2}, {"a":3, "b":4}]' );

SELECT jsonb_object_keys('{"a":1, "b":2, "c":3}');

SELECT jsonb_typeof(attributes) FROM products;

SELECT jsonb_build_object('product_name', name, 'product_price', price) FROM products;

SELECT jsonb_agg(attributes) FROM products;

-- Using window functions with JSONB
SELECT
    name,
    price,
    attributes ->> 'processor' AS processor,
    ROW_NUMBER() OVER (ORDER BY price DESC) AS row_num
FROM
    products;

-- Create a temporary table with JSONB data
CREATE TEMP TABLE temp_json_table (
    id SERIAL PRIMARY KEY,
    data JSONB
);

INSERT INTO temp_json_table (data) VALUES
('{"name": "Alice", "age": 30, "city": "New York"}'),
('{"name": "Bob", "age": 25, "city": "Los Angeles"}');

-- Query the temporary table
SELECT data ->> 'name', data ->> 'age' FROM temp_json_table;

-- Using jsonb_each to extract key-value pairs
SELECT (jsonb_each(data)).key, (jsonb_each(data)).value FROM temp_json_table;

-- Testing jsonb_insert
SELECT jsonb_insert('{"a": [1, 2]}', '{a, 1}', '3');
SELECT jsonb_insert('{"a": [1, 2]}', '{a, 1}', '3', true);
SELECT jsonb_insert('{"a": [1, 2]}', '{a, 5}', '3');

-- Testing jsonb_set_lax
SELECT jsonb_set_lax('{"a": 1, "b": 2}', '{b}', '5');
SELECT jsonb_set_lax('{"a": 1, "b": 2}', '{d}', '6', true);
SELECT jsonb_set_lax('{"a": 1, "b": 2}', '{b}', null, null_value_treatment => 'delete_key');

-- Testing jsonb_path_query
SELECT jsonb_path_query('{"a": [{"b": 1}, {"b": 2}]}', '$.a[*].b');

-- Testing jsonb_path_query_array
SELECT jsonb_path_query_array('{"a": [{"b": 1}, {"b": 2}]}', '$.a[*].b');

-- Testing jsonb_path_exists
SELECT jsonb_path_exists('{"a": [{"b": 1}, {"b": 2}]}', '$.a[*].b ? (@ > 1)');

-- Create an index on a jsonb array element
CREATE INDEX products_brand_idx ON products ((attributes ->> 'brand'));

-- Querying with jsonb_contains
SELECT * FROM products WHERE jsonb_contains(attributes, '{"brand": "Dell"}');

-- Clean up temporary table
DROP TABLE IF EXISTS temp_json_table;

-- Table with a GENERATED column
CREATE TABLE json_data (
    id SERIAL PRIMARY KEY,
    raw_data JSONB,
    processed_data TEXT GENERATED ALWAYS AS (raw_data ->> 'name') STORED
);

INSERT INTO json_data (raw_data) VALUES ('{"name": "Charlie", "age": 40}');

SELECT * FROM json_data;