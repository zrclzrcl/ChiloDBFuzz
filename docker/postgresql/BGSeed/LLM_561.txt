CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Basic table creation
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL CHECK (price > 0)
);

CREATE TABLE IF NOT EXISTS orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    order_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    total_amount DECIMAL(10, 2) NOT NULL
);

CREATE TABLE IF NOT EXISTS order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    product_id INTEGER REFERENCES products(id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price DECIMAL(10, 2) NOT NULL
);

-- Insert some sample data
INSERT INTO users (username, email) VALUES
('john_doe', 'john.doe@example.com'),
('jane_smith', 'jane.smith@example.com');

INSERT INTO products (name, description, price) VALUES
('Laptop', 'High-performance laptop', 1200.00),
('Mouse', 'Wireless mouse', 25.00),
('Keyboard', 'Mechanical keyboard', 75.00);

INSERT INTO orders (user_id, total_amount) VALUES
(1, 1300.00),
(2, 75.00);

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
(1, 1, 1, 1200.00),
(1, 2, 4, 25.00),
(2, 3, 1, 75.00);

-- Some SELECT queries with various clauses
SELECT * FROM users WHERE username LIKE 'j%';
SELECT p.name, p.price FROM products p ORDER BY p.price DESC LIMIT 2;
SELECT o.order_date, SUM(oi.quantity * oi.price) AS total FROM orders o JOIN order_items oi ON o.id = oi.order_id GROUP BY o.order_date;

-- UPDATE and DELETE statements
UPDATE products SET price = price * 1.1 WHERE id = 1;
DELETE FROM order_items WHERE quantity = 1;

-- Using WITH clause (CTE)
WITH high_value_orders AS (
    SELECT user_id, SUM(total_amount) AS total FROM orders GROUP BY user_id HAVING SUM(total_amount) > 1000
)
SELECT u.username, hvo.total FROM users u JOIN high_value_orders hvo ON u.id = hvo.user_id;

-- JSON and JSONB examples
CREATE TABLE IF NOT EXISTS json_data (
    id SERIAL PRIMARY KEY,
    data JSONB
);

INSERT INTO json_data (data) VALUES
('{"name": "Product A", "price": 100, "details": {"color": "red", "size": "large"}}'),
('{"name": "Product B", "price": 200, "details": {"color": "blue", "size": "small"}}');

SELECT data ->> 'name' AS product_name, (data -> 'details' ->> 'color') AS color FROM json_data;

-- Array examples
CREATE TABLE IF NOT EXISTS tags (
    id SERIAL PRIMARY KEY,
    tag_names TEXT[]
);

INSERT INTO tags (tag_names) VALUES
(ARRAY['electronics', 'laptop', 'high-performance']),
(ARRAY['accessories', 'mouse', 'wireless']);

SELECT tag_names[1] FROM tags;

-- UNLOGGED TABLE example
CREATE UNLOGGED TABLE IF NOT EXISTS temp_data (
    id SERIAL PRIMARY KEY,
    value TEXT
);

INSERT INTO temp_data (value) SELECT md5(random()::text) FROM generate_series(1, 1000);

-- GENERATED AS IDENTITY example
CREATE TABLE IF NOT EXISTS identity_test (
    id INTEGER GENERATED ALWAYS AS IDENTITY,
    name TEXT
);

INSERT INTO identity_test (name) VALUES ('Test 1'), ('Test 2');
SELECT * FROM identity_test;

-- pg_sleep example
DO $$
BEGIN
  RAISE NOTICE 'Sleeping for 1 second...';
  PERFORM pg_sleep(1);
  RAISE NOTICE 'Woke up!';
END $$;

-- Window Function Example
SELECT
    product_id,
    price,
    RANK() OVER (ORDER BY price DESC) as price_rank
FROM
    order_items;