CREATE TABLE employees (
    employee_id SERIAL PRIMARY KEY,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    hire_date DATE,
    salary DECIMAL(10, 2),
    department_id INTEGER,
    json_data jsonb
);

CREATE TABLE departments (
    department_id SERIAL PRIMARY KEY,
    department_name VARCHAR(50) NOT NULL
);

ALTER TABLE employees ADD CONSTRAINT fk_department
    FOREIGN KEY (department_id) REFERENCES departments(department_id);

INSERT INTO departments (department_name) VALUES ('Sales');
INSERT INTO departments (department_name) VALUES ('Marketing');
INSERT INTO departments (department_name) VALUES ('Engineering');

INSERT INTO employees (first_name, last_name, email, hire_date, salary, department_id, json_data)
VALUES ('John', 'Doe', 'john.doe@example.com', '2023-01-15', 60000.00, 1, '{"title": "Sales Representative", "level": "Junior"}');
INSERT INTO employees (first_name, last_name, email, hire_date, salary, department_id, json_data)
VALUES ('Jane', 'Smith', 'jane.smith@example.com', '2022-05-20', 75000.00, 2, '{"title": "Marketing Manager", "level": "Senior"}');
INSERT INTO employees (first_name, last_name, email, hire_date, salary, department_id, json_data)
VALUES ('Peter', 'Jones', 'peter.jones@example.com', '2023-03-01', 80000.00, 3, '{"title": "Software Engineer", "level": "Mid"}');

SELECT * FROM employees WHERE salary > 70000;

UPDATE employees SET salary = salary * 1.1 WHERE department_id = 1;

DELETE FROM employees WHERE employee_id = 1;

SELECT d.department_name, COUNT(e.employee_id) AS employee_count
FROM departments d
LEFT JOIN employees e ON d.department_id = e.department_id
GROUP BY d.department_name
ORDER BY employee_count DESC;

CREATE INDEX idx_employee_last_name ON employees (last_name);

SELECT first_name, last_name, email FROM employees WHERE last_name LIKE 'J%';

SELECT employee_id, first_name, last_name, json_data ->> 'title' AS job_title FROM employees;

CREATE VIEW high_earners AS
SELECT first_name, last_name, salary FROM employees WHERE salary > 75000;

SELECT * FROM high_earners;

WITH EmployeeSalaries AS (
    SELECT department_id, AVG(salary) AS avg_salary
    FROM employees
    GROUP BY department_id
)
SELECT d.department_name, es.avg_salary
FROM departments d
JOIN EmployeeSalaries es ON d.department_id = es.department_id;

CREATE OR REPLACE FUNCTION increment_salary(emp_id INTEGER, increment DECIMAL)
RETURNS VOID AS $$
BEGIN
    UPDATE employees SET salary = salary + increment WHERE employee_id = emp_id;
END;
$$ LANGUAGE plpgsql;

SELECT increment_salary(2, 5000);

SELECT * FROM employees WHERE employee_id = 2;

CREATE UNLOGGED TABLE temp_data (
    id SERIAL PRIMARY KEY,
    value VARCHAR(255)
);

INSERT INTO temp_data (value) VALUES ('Temporary data entry 1');

CREATE EXTENSION IF NOT EXISTS citext;
ALTER TABLE employees ALTER COLUMN email TYPE citext;