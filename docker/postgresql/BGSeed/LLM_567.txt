CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    salary DECIMAL(10, 2),
    hire_date DATE,
    department VARCHAR(50)
);

INSERT INTO employees (name, salary, hire_date, department) VALUES
('Alice Smith', 60000.00, '2022-01-15', 'Sales'),
('Bob Johnson', 75000.00, '2021-05-20', 'Marketing'),
('Charlie Brown', 55000.00, '2023-03-01', 'Sales'),
('Diana Miller', 80000.00, '2020-11-10', 'Engineering'),
('Eve Davis', 90000.00, '2019-09-05', 'Engineering');

CREATE INDEX idx_department ON employees (department);

SELECT department, AVG(salary) AS average_salary
FROM employees
GROUP BY department
HAVING AVG(salary) > 65000;

UPDATE employees
SET salary = salary * 1.10
WHERE department = 'Sales';

DELETE FROM employees WHERE id = 3;

CREATE VIEW high_earners AS
SELECT name, salary, department
FROM employees
WHERE salary > 70000;

SELECT * FROM high_earners;

CREATE OR REPLACE FUNCTION get_employee_count(dept VARCHAR)
RETURNS INTEGER AS $$
BEGIN
    RETURN (SELECT COUNT(*) FROM employees WHERE department = dept);
END;
$$ LANGUAGE plpgsql;

SELECT get_employee_count('Engineering');

CREATE TYPE address AS (
    street VARCHAR(100),
    city VARCHAR(50),
    zip_code VARCHAR(10)
);

CREATE TABLE departments (
    dept_id SERIAL PRIMARY KEY,
    dept_name VARCHAR(50),
    location address
);

INSERT INTO departments (dept_name, location) VALUES
('Sales', ROW('123 Main St', 'Anytown', '12345')::address),
('Marketing', ROW('456 Oak Ave', 'Springfield', '67890')::address);

SELECT (location).city FROM departments WHERE dept_name = 'Sales';

CREATE TABLE audit_log (
    event_time TIMESTAMP WITH TIME ZONE DEFAULT now(),
    table_name VARCHAR(255),
    operation VARCHAR(50),
    details TEXT
);

CREATE OR REPLACE FUNCTION log_employee_changes()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'UPDATE') THEN
        INSERT INTO audit_log (table_name, operation, details)
        VALUES ('employees', 'UPDATE', 'Updated employee with ID = ' || OLD.id);
        RETURN NEW;
    ELSIF (TG_OP = 'DELETE') THEN
        INSERT INTO audit_log (table_name, operation, details)
        VALUES ('employees', 'DELETE', 'Deleted employee with ID = ' || OLD.id);
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER employee_audit
AFTER UPDATE OR DELETE ON employees
FOR EACH ROW
EXECUTE FUNCTION log_employee_changes();

UPDATE employees SET salary = 85000 WHERE id = 2;
DELETE FROM employees WHERE id = 4;

SELECT * FROM audit_log;

-- Using window functions
SELECT
    name,
    salary,
    department,
    RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS salary_rank
FROM
    employees;

-- Using common table expressions (CTEs)
WITH DepartmentAverages AS (
    SELECT
        department,
        AVG(salary) AS avg_salary
    FROM
        employees
    GROUP BY
        department
)
SELECT
    e.name,
    e.salary,
    e.department,
    da.avg_salary
FROM
    employees e
JOIN
    DepartmentAverages da ON e.department = da.department
WHERE e.salary > da.avg_salary;

-- Demonstrating JSON functionality
ALTER TABLE employees ADD COLUMN details JSONB;
UPDATE employees SET details = '{"performance": "good", "experience": 5}' WHERE id = 1;
SELECT name, details ->> 'performance' AS performance FROM employees;

-- Demonstrating array functionality
ALTER TABLE employees ADD COLUMN skills TEXT[];
UPDATE employees SET skills = ARRAY['SQL', 'Python', 'Data Analysis'] WHERE id = 1;
SELECT name, skills[1] AS first_skill FROM employees;

-- Using generate_series
SELECT generate_series(1, 10);

-- Create and use a temporary table
CREATE TEMP TABLE temp_employees AS SELECT * FROM employees WHERE salary > 60000;
SELECT * FROM temp_employees;

-- Example of a foreign key constraint (create a company table first)
CREATE TABLE companies (
    company_id SERIAL PRIMARY KEY,
    company_name VARCHAR(100) NOT NULL
);
INSERT INTO companies (company_name) VALUES ('Acme Corp'), ('Beta Inc');
ALTER TABLE employees ADD COLUMN company_id INT;
UPDATE employees SET company_id = 1; -- Assign a company to existing employees
ALTER TABLE employees ADD CONSTRAINT fk_company FOREIGN KEY (company_id) REFERENCES companies(company_id);

-- Example using materialized view
CREATE MATERIALIZED VIEW high_earners_mv AS SELECT * FROM employees WHERE salary > 70000;
SELECT * FROM high_earners_mv;
REFRESH MATERIALIZED VIEW high_earners_mv;

-- Example using unnest
SELECT skill FROM employees, unnest(skills) AS skill WHERE id = 1;