CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    uuid UUID DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    order_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    total_amount DECIMAL(10, 2) NOT NULL
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    product_id INTEGER REFERENCES products(id),
    quantity INTEGER NOT NULL,
    price DECIMAL(10, 2) NOT NULL
);

INSERT INTO users (username, email) VALUES
    ('john_doe', 'john.doe@example.com'),
    ('jane_smith', 'jane.smith@example.com');

INSERT INTO products (name, description, price) VALUES
    ('Laptop', 'High-performance laptop', 1200.00),
    ('Mouse', 'Wireless mouse', 25.00);

INSERT INTO orders (user_id, total_amount) VALUES
    (1, 1225.00),
    (2, 25.00);

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
    (1, 1, 1, 1200.00),
    (1, 2, 1, 25.00),
    (2, 2, 1, 25.00);

CREATE INDEX idx_users_username ON users (username);
CREATE INDEX idx_orders_user_id ON orders (user_id);

CREATE VIEW user_order_summary AS
SELECT
    u.username,
    COUNT(o.id) AS total_orders,
    SUM(o.total_amount) AS total_spent
FROM
    users u
LEFT JOIN
    orders o ON u.id = o.user_id
GROUP BY
    u.username;

CREATE OR REPLACE FUNCTION calculate_discount(price DECIMAL, discount_percentage DECIMAL)
RETURNS DECIMAL AS $$
BEGIN
    RETURN price - (price * (discount_percentage / 100));
END;
$$ LANGUAGE plpgsql;

CREATE DOMAIN email AS VARCHAR(255) CHECK (VALUE LIKE '%@%');

ALTER TABLE users ADD COLUMN verified BOOLEAN DEFAULT FALSE;

UPDATE users SET verified = TRUE WHERE id = 1;

DELETE FROM order_items WHERE order_id = 2;

WITH product_sales AS (
    SELECT
        p.name,
        SUM(oi.quantity) AS total_quantity_sold
    FROM
        products p
    JOIN
        order_items oi ON p.id = oi.product_id
    GROUP BY
        p.name
    ORDER BY
        total_quantity_sold DESC
)
SELECT * FROM product_sales;

SELECT generate_series(1, 10);

SELECT UNNEST(ARRAY[1, 2, 3, 4, 5]);

CREATE TYPE inventory_record AS (
    product_name VARCHAR(100),
    quantity INTEGER
);

CREATE TABLE inventory (
    id SERIAL PRIMARY KEY,
    record inventory_record
);

INSERT INTO inventory (record) VALUES (ROW('Widget', 100));

SELECT (record).product_name, (record).quantity FROM inventory;

CREATE TABLE meeting_schedule (
    id SERIAL PRIMARY KEY,
    scheduled_time tstzrange
);

INSERT INTO meeting_schedule (scheduled_time) VALUES ('[2024-01-01 10:00:00+00, 2024-01-01 11:00:00+00)');

SELECT * FROM meeting_schedule WHERE scheduled_time @> '2024-01-01 10:30:00+00'::timestamptz;

CREATE OR REPLACE FUNCTION increment_product_price(product_id INTEGER, increment DECIMAL)
RETURNS VOID AS $$
BEGIN
    UPDATE products SET price = price + increment WHERE id = product_id;
END;
$$ LANGUAGE plpgsql;

SELECT increment_product_price(1, 100.00);
EXPLAIN SELECT * FROM users WHERE username = 'john_doe';

BEGIN;
UPDATE products SET price = price * 1.1 WHERE id = 1;
SELECT * FROM products WHERE id = 1;
ROLLBACK;