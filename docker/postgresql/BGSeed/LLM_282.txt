CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    email VARCHAR(100) UNIQUE,
    hire_date DATE,
    job_id INTEGER,
    salary DECIMAL(10, 2),
    department_id INTEGER
);

CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE,
    location_id INTEGER
);

CREATE TABLE locations (
    id SERIAL PRIMARY KEY,
    address VARCHAR(100),
    postal_code VARCHAR(20),
    city VARCHAR(50),
    state VARCHAR(50),
    country VARCHAR(50)
);

CREATE TABLE jobs (
    id SERIAL PRIMARY KEY,
    title VARCHAR(50) UNIQUE,
    min_salary DECIMAL(10, 2),
    max_salary DECIMAL(10, 2)
);

INSERT INTO locations (address, postal_code, city, state, country) VALUES
('123 Main St', '12345', 'Anytown', 'CA', 'USA'),
('456 Oak Ave', '67890', 'Springfield', 'IL', 'USA'),
('789 Pine Ln', '10111', 'Hill Valley', 'CA', 'USA');

INSERT INTO departments (name, location_id) VALUES
('Sales', 1),
('Marketing', 2),
('Engineering', 3);

INSERT INTO jobs (title, min_salary, max_salary) VALUES
('Sales Representative', 40000.00, 60000.00),
('Marketing Manager', 60000.00, 80000.00),
('Software Engineer', 80000.00, 120000.00);

INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES
('John', 'Doe', 'john.doe@example.com', '2022-01-15', 1, 50000.00, 1),
('Jane', 'Smith', 'jane.smith@example.com', '2022-03-01', 2, 70000.00, 2),
('Robert', 'Jones', 'robert.jones@example.com', '2022-05-10', 3, 90000.00, 3);

SELECT * FROM employees WHERE salary > 60000;
SELECT first_name, last_name FROM employees WHERE department_id = 1;
UPDATE employees SET salary = salary * 1.10 WHERE department_id = 3;
DELETE FROM employees WHERE id = 1;
SELECT COUNT(*) FROM employees;
SELECT AVG(salary) FROM employees;
SELECT MAX(salary) FROM employees;
SELECT MIN(salary) FROM employees;
SELECT SUM(salary) FROM employees;
SELECT department_id, AVG(salary) FROM employees GROUP BY department_id;
SELECT department_id, COUNT(*) FROM employees GROUP BY department_id HAVING COUNT(*) > 1;
SELECT e.first_name, e.last_name, d.name FROM employees e JOIN departments d ON e.department_id = d.id;
SELECT e.first_name, e.last_name, d.name FROM employees e LEFT JOIN departments d ON e.department_id = d.id;
SELECT e.first_name, e.last_name, d.name FROM employees e RIGHT JOIN departments d ON e.department_id = d.id;
SELECT e.first_name, e.last_name, d.name FROM employees e FULL OUTER JOIN departments d ON e.department_id = d.id;
SELECT e.first_name, e.last_name FROM employees WHERE EXISTS (SELECT 1 FROM departments WHERE id = e.department_id);
SELECT e.first_name, e.last_name FROM employees WHERE salary IN (SELECT min_salary FROM jobs);
SELECT e.first_name, e.last_name FROM employees WHERE salary > ALL (SELECT min_salary FROM jobs);
SELECT e.first_name, e.last_name FROM employees WHERE salary > ANY (SELECT min_salary FROM jobs);
SELECT * FROM employees ORDER BY last_name ASC, first_name DESC;
SELECT * FROM employees LIMIT 2;
SELECT * FROM employees OFFSET 1 LIMIT 1;

CREATE INDEX idx_employees_last_name ON employees (last_name);
DROP INDEX idx_employees_last_name;
CREATE VIEW employee_details AS SELECT e.first_name, e.last_name, d.name AS department_name FROM employees e JOIN departments d ON e.department_id = d.id;
SELECT * FROM employee_details;
DROP VIEW employee_details;
ALTER TABLE employees ADD COLUMN phone_number VARCHAR(20);
ALTER TABLE employees DROP COLUMN phone_number;

SELECT version();
SHOW server_version;
SHOW server_version_num;
SHOW data_directory;
SHOW default_transaction_isolation;
SHOW default_transaction_read_only;

PREPARE my_query (int) AS SELECT * FROM employees WHERE id = $1;
EXECUTE my_query(2);
DEALLOCATE my_query;

CREATE FUNCTION get_employee_count() RETURNS integer AS $$
BEGIN
  RETURN (SELECT COUNT(*) FROM employees);
END;
$$ LANGUAGE plpgsql;

SELECT get_employee_count();
DROP FUNCTION get_employee_count();

CREATE OR REPLACE FUNCTION calculate_bonus(employee_salary DECIMAL, bonus_percentage DECIMAL)
RETURNS DECIMAL AS $$
BEGIN
    RETURN employee_salary * bonus_percentage;
END;
$$ LANGUAGE plpgsql;

SELECT calculate_bonus(60000.00, 0.10);
DROP FUNCTION calculate_bonus(DECIMAL, DECIMAL);

-- Partitioning
CREATE TABLE sales (
    sale_id SERIAL PRIMARY KEY,
    sale_date DATE,
    amount DECIMAL(10, 2)
) PARTITION BY RANGE (sale_date);

CREATE TABLE sales_y2023 PARTITION OF sales FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');
CREATE TABLE sales_y2024 PARTITION OF sales FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

INSERT INTO sales (sale_date, amount) VALUES ('2023-05-15', 100.00), ('2024-10-20', 200.00);
SELECT * FROM sales;

DROP TABLE sales_y2023;
DROP TABLE sales_y2024;
DROP TABLE sales;

-- Window Functions
SELECT
    first_name,
    last_name,
    salary,
    RANK() OVER (ORDER BY salary DESC) as salary_rank
FROM
    employees;

SELECT
    first_name,
    last_name,
    salary,
    DENSE_RANK() OVER (ORDER BY salary DESC) as salary_dense_rank
FROM
    employees;

SELECT
    first_name,
    last_name,
    salary,
    ROW_NUMBER() OVER (ORDER BY salary DESC) as salary_row_number
FROM
    employees;

SELECT
    first_name,
    last_name,
    salary,
    NTILE(4) OVER (ORDER BY salary DESC) as salary_ntile
FROM
    employees;

-- Common Table Expressions (CTEs)
WITH EmployeeSalaries AS (
    SELECT first_name, last_name, salary
    FROM employees
    WHERE department_id = 3
)
SELECT * FROM EmployeeSalaries WHERE salary > 85000;

-- Materialized Views
CREATE MATERIALIZED VIEW high_salary_employees AS
SELECT first_name, last_name, salary
FROM employees
WHERE salary > 75000;

SELECT * FROM high_salary_employees;
REFRESH MATERIALIZED VIEW high_salary_employees;
DROP MATERIALIZED VIEW high_salary_employees;

-- JSON Functions and Operators
SELECT json_build_object('name', first_name, 'salary', salary) AS employee_json FROM employees;
SELECT * FROM json_populate_record(NULL::employees, '{"first_name":"Alice", "last_name":"Brown", "salary":75000}');

DROP TABLE employees;
DROP TABLE departments;
DROP TABLE locations;
DROP TABLE jobs;