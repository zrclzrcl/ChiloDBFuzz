CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(50) NOT NULL,
    price DECIMAL(10, 2)
);

CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(50) NOT NULL,
    email VARCHAR(50) UNIQUE
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INT REFERENCES customers(customer_id),
    order_date DATE,
    total_amount DECIMAL(10, 2)
);

CREATE TABLE order_items (
    order_item_id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(order_id),
    product_id INT REFERENCES products(product_id),
    quantity INT,
    unit_price DECIMAL(10, 2)
);

INSERT INTO products (product_name, price) VALUES
('Laptop', 1200.00),
('Mouse', 25.00),
('Keyboard', 75.00),
('Monitor', 300.00);

INSERT INTO customers (customer_name, email) VALUES
('John Doe', 'john.doe@example.com'),
('Jane Smith', 'jane.smith@example.com');

INSERT INTO orders (customer_id, order_date, total_amount) VALUES
(1, '2024-01-15', 1500.00),
(2, '2024-01-20', 375.00);

INSERT INTO order_items (order_id, product_id, quantity, unit_price) VALUES
(1, 1, 1, 1200.00),
(1, 3, 4, 75.00),
(2, 2, 1, 25.00),
(2, 4, 1, 350.00);

SELECT c.customer_name, o.order_date, SUM(oi.quantity * oi.unit_price) AS total
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY c.customer_name, o.order_date
ORDER BY c.customer_name, o.order_date;

UPDATE products SET price = 1300.00 WHERE product_name = 'Laptop';

DELETE FROM products WHERE product_name = 'Mouse';

CREATE INDEX idx_customer_id ON orders (customer_id);

CREATE VIEW customer_order_totals AS
SELECT c.customer_name, SUM(o.total_amount) AS total_spent
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_name;

SELECT * FROM customer_order_totals;

CREATE FUNCTION calculate_discount(price DECIMAL, discount_percentage DECIMAL)
RETURNS DECIMAL AS $$
BEGIN
    RETURN price - (price * discount_percentage / 100);
END;
$$ LANGUAGE plpgsql;

SELECT product_name, price, calculate_discount(price, 10) AS discounted_price FROM products;

ALTER TABLE products ADD COLUMN description TEXT;

UPDATE products SET description = 'High-performance laptop' WHERE product_name = 'Laptop';

SELECT * FROM products WHERE description LIKE '%performance%';

-- Using window functions
SELECT
    product_name,
    price,
    AVG(price) OVER () AS average_price
FROM
    products;

-- Using Common Table Expressions (CTEs)
WITH ExpensiveProducts AS (
    SELECT product_name, price
    FROM products
    WHERE price > 100
)
SELECT product_name, price FROM ExpensiveProducts ORDER BY price DESC;

-- Trigger example
CREATE OR REPLACE FUNCTION update_order_total()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE orders
    SET total_amount = (
        SELECT SUM(quantity * unit_price)
        FROM order_items
        WHERE order_id = NEW.order_id
    )
    WHERE order_id = NEW.order_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER order_items_after_insert
AFTER INSERT ON order_items
FOR EACH ROW
EXECUTE FUNCTION update_order_total();

INSERT INTO order_items (order_id, product_id, quantity, unit_price) VALUES (2,1,1,1200);

-- Check constraint
ALTER TABLE products ADD CONSTRAINT price_positive CHECK (price > 0);

-- Foreign data wrapper
CREATE EXTENSION IF NOT EXISTS file_fdw;
CREATE SERVER IF NOT EXISTS my_csv_server
FOREIGN DATA WRAPPER file_fdw;
CREATE FOREIGN TABLE IF NOT EXISTS csv_data (
  product_name varchar(50),
  price decimal
)
SERVER my_csv_server
OPTIONS (filename '/tmp/products.csv', format 'csv', header 'true');
-- Import data and cleanup
-- CREATE TEMP TABLE products_temp AS SELECT * FROM products;
-- DROP TABLE products;
-- ALTER TABLE products_temp RENAME TO products;
-- DROP FOREIGN TABLE IF EXISTS csv_data;
-- DROP SERVER IF EXISTS my_csv_server;
-- DROP EXTENSION IF EXISTS file_fdw;

-- Advanced Aggregation (JSON)
SELECT customer_name, json_agg(orders) as orders FROM customers LEFT JOIN (SELECT customer_id, json_build_object('order_id', order_id, 'order_date', order_date, 'total_amount', total_amount) AS orders FROM orders) AS o USING (customer_id) GROUP BY customer_name;

DROP TABLE order_items;
DROP TABLE orders;
DROP TABLE customers;
DROP TABLE products;
DROP VIEW customer_order_totals;
DROP FUNCTION calculate_discount(DECIMAL, DECIMAL);
DROP FUNCTION update_order_total();