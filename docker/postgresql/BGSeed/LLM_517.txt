CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100),
    password_hash TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL CHECK (price > 0),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    order_date TIMESTAMP WITH TIME ZONE DEFAULT now(),
    total_amount DECIMAL(10, 2) NOT NULL
);

CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(order_id),
    product_id INTEGER REFERENCES products(product_id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price DECIMAL(10, 2) NOT NULL
);

INSERT INTO users (username, email, password_hash) VALUES
    ('john_doe', 'john.doe@example.com', crypt('password123', gen_salt('bf'))),
    ('jane_smith', 'jane.smith@example.com', crypt('securepass', gen_salt('bf'))),
    ('peter_jones', 'peter.jones@example.com', crypt('testpass', gen_salt('bf')));

INSERT INTO products (name, description, price) VALUES
    ('Laptop', 'High-performance laptop', 1200.00),
    ('Mouse', 'Wireless mouse', 25.00),
    ('Keyboard', 'Mechanical keyboard', 75.00);

INSERT INTO orders (user_id, total_amount) VALUES
    (1, 1225.00),
    (2, 75.00),
    (3, 25.00);

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
    (1, 1, 1, 1200.00),
    (1, 2, 1, 25.00),
    (2, 3, 1, 75.00),
    (3, 2, 1, 25.00);

CREATE INDEX idx_users_username ON users (username);
CREATE INDEX CONCURRENTLY idx_products_name ON products (name);

SELECT u.username, o.order_date, oi.quantity, p.name AS product_name
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
WHERE u.username = 'john_doe'
ORDER BY o.order_date DESC;

UPDATE products SET price = price * 1.1 WHERE product_id = 1;

DELETE FROM order_items WHERE order_id = 3;

-- Example of using JSONB
CREATE TABLE configurations (
    id SERIAL PRIMARY KEY,
    config JSONB
);

INSERT INTO configurations (config) VALUES
    ('{"setting1": "value1", "setting2": 123, "setting3": {"nested": true}}'),
    ('{"setting1": "value2", "setting2": 456}');

SELECT config -> 'setting2' FROM configurations WHERE id = 1;

-- Example of using GENERATED AS IDENTITY
CREATE TABLE employees (
    id INT GENERATED ALWAYS AS IDENTITY,
    name VARCHAR(255)
);

INSERT INTO employees (name) VALUES ('Alice'), ('Bob');

SELECT * FROM employees;

-- Example of user defined type
CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');
CREATE TABLE person (
    name text,
    current_mood mood
);
INSERT INTO person VALUES ('Bob', 'happy');
SELECT * FROM person;

-- Example of CREATE OR REPLACE FUNCTION
CREATE OR REPLACE FUNCTION add_them(a INTEGER, b INTEGER) RETURNS INTEGER AS $$
        BEGIN
                RETURN a + b;
        END;
$$ LANGUAGE plpgsql;

SELECT add_them(1,2);