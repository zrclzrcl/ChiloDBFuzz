CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    salary DECIMAL(10, 2),
    department VARCHAR(50),
    hire_date DATE
);

INSERT INTO employees (name, salary, department, hire_date) VALUES
('Alice Smith', 60000.00, 'Sales', '2022-01-15'),
('Bob Johnson', 75000.00, 'Marketing', '2021-05-20'),
('Charlie Brown', 55000.00, 'Sales', '2023-03-10'),
('David Lee', 80000.00, 'Engineering', '2020-11-01'),
('Eve Wilson', 90000.00, 'Engineering', '2022-08-01');

CREATE INDEX idx_employees_department ON employees (department);

SELECT department, AVG(salary) AS average_salary FROM employees GROUP BY department;

UPDATE employees SET salary = salary * 1.1 WHERE department = 'Sales';

DELETE FROM employees WHERE hire_date < '2021-01-01';

ALTER TABLE employees ADD COLUMN email VARCHAR(100) UNIQUE;

UPDATE employees SET email = LOWER(REPLACE(name, ' ', '.')) || '@example.com';

SELECT * FROM employees WHERE name LIKE 'A%';

SELECT id, name, salary FROM employees ORDER BY salary DESC LIMIT 3;

CREATE VIEW sales_employees AS SELECT id, name, salary FROM employees WHERE department = 'Sales';

SELECT * FROM sales_employees;

DROP VIEW sales_employees;

CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE
);

INSERT INTO departments (name) VALUES ('Sales'), ('Marketing'), ('Engineering');

ALTER TABLE employees ADD COLUMN department_id INTEGER REFERENCES departments(id);

UPDATE employees SET department_id = (SELECT id FROM departments WHERE name = employees.department);

ALTER TABLE employees DROP COLUMN department;

SELECT e.name, d.name AS department FROM employees e JOIN departments d ON e.department_id = d.id;

CREATE FUNCTION calculate_bonus(employee_id INTEGER) RETURNS DECIMAL(10, 2) AS $$
BEGIN
    RETURN (SELECT salary * 0.1 FROM employees WHERE id = employee_id);
END;
$$ LANGUAGE plpgsql;

SELECT id, name, calculate_bonus(id) AS bonus FROM employees;

DROP FUNCTION calculate_bonus(INTEGER);

CREATE MATERIALIZED VIEW employee_salaries AS
SELECT department_id, AVG(salary) AS avg_salary
FROM employees
GROUP BY department_id;

REFRESH MATERIALIZED VIEW employee_salaries;

SELECT * FROM employee_salaries;

DROP MATERIALIZED VIEW employee_salaries;

CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10, 2)
);

INSERT INTO products (name, price) VALUES ('Laptop', 1200.00), ('Mouse', 25.00), ('Keyboard', 75.00);

SELECT * FROM products WHERE price BETWEEN 50 AND 1500;

SELECT name, price FROM products UNION ALL SELECT name, salary FROM employees;

CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');

CREATE TABLE person (
    name text,
    current_mood mood
);

INSERT INTO person (name, current_mood) VALUES ('Alice', 'happy');
INSERT INTO person (name, current_mood) VALUES ('Bob', 'sad');

SELECT name, current_mood FROM person;

CREATE TABLE inventory (
    id SERIAL PRIMARY KEY,
    product_id INTEGER REFERENCES products(id),
    quantity INTEGER
);

INSERT INTO inventory (product_id, quantity) VALUES (1, 10), (2, 50), (3, 25);

SELECT p.name, i.quantity FROM products p LEFT JOIN inventory i ON p.id = i.product_id;

SELECT json_agg(row_to_json(t)) FROM (SELECT * FROM employees) t;

SELECT xmlforest(name, salary) FROM employees;

-- Demonstrate window functions
SELECT
    name,
    salary,
    RANK() OVER (ORDER BY salary DESC) as salary_rank
FROM
    employees;

-- Demonstrate common table expression (CTE)
WITH RankedSalaries AS (
    SELECT
        name,
        salary,
        RANK() OVER (ORDER BY salary DESC) as salary_rank
    FROM
        employees
)
SELECT
    name,
    salary
FROM
    RankedSalaries
WHERE
    salary_rank <= 3;

-- Demonstrate generate_series
SELECT generate_series(1, 5);

-- Demonstrate unnest
SELECT unnest(ARRAY['a','b','c']);

-- Demonstrate advisory lock
SELECT pg_advisory_lock(1);
SELECT pg_advisory_unlock(1);

-- Demonstrate pg_sleep
SELECT pg_sleep(1);

-- Demonstrate UUID generation
SELECT uuid_generate_v4();

-- Demonstrate large object support
CREATE TABLE lob_table (
    id SERIAL PRIMARY KEY,
    data OID
);

INSERT INTO lob_table (data) VALUES (lo_create(gen_random_uuid()));

SELECT lo_unlink(data) FROM lob_table;

DROP TABLE lob_table;

-- Demonstrate using LIKE with escape character
SELECT * FROM employees WHERE name LIKE '%!%%' ESCAPE '!';

-- Test case-insensitive comparison using ILIKE
SELECT * FROM employees WHERE name ILIKE 'a%';

-- Use DISTINCT ON to get the first employee in each department
SELECT DISTINCT ON (department_id) e.name, d.name AS department
FROM employees e
JOIN departments d ON e.department_id = d.id
ORDER BY department_id, salary DESC;

-- Demonstrate using NULLIF
SELECT NULLIF(10, 10);

-- Demonstrate COALESCE
SELECT COALESCE(NULL, 'default value');

-- Check table size
SELECT pg_size_pretty(pg_total_relation_size('employees'));

-- Analyze table for query planning
ANALYZE employees;

-- Vacuum table to reclaim space
VACUUM employees;

-- Create a partial index
CREATE INDEX idx_employees_high_salary ON employees (salary) WHERE salary > 70000;

-- Drop the partial index
DROP INDEX idx_employees_high_salary;

-- Use EXPLAIN to analyze a query
EXPLAIN SELECT * FROM employees WHERE salary > 70000;