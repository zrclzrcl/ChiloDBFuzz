CREATE TABLE employee (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    salary DECIMAL(10, 2),
    hire_date DATE,
    department_id INT
);

CREATE TABLE department (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    location VARCHAR(255)
);

ALTER TABLE employee ADD CONSTRAINT fk_department_id FOREIGN KEY (department_id) REFERENCES department(id);

INSERT INTO department (name, location) VALUES ('Sales', 'New York');
INSERT INTO department (name, location) VALUES ('Marketing', 'London');
INSERT INTO department (name, location) VALUES ('Engineering', 'San Francisco');

INSERT INTO employee (name, salary, hire_date, department_id) VALUES ('John Doe', 60000.00, '2022-01-15', 1);
INSERT INTO employee (name, salary, hire_date, department_id) VALUES ('Jane Smith', 75000.00, '2021-05-20', 2);
INSERT INTO employee (name, salary, hire_date, department_id) VALUES ('Peter Jones', 90000.00, '2020-11-01', 3);
INSERT INTO employee (name, salary, hire_date, department_id) VALUES ('Alice Brown', 65000.00, '2023-03-10', 1);
INSERT INTO employee (name, salary, hire_date, department_id) VALUES ('Bob Williams', 80000.00, '2022-09-05', 2);

SELECT * FROM employee WHERE salary > 70000.00;
SELECT name, salary FROM employee ORDER BY salary DESC LIMIT 2;
UPDATE employee SET salary = salary * 1.1 WHERE department_id = 1;
DELETE FROM employee WHERE id = 4;

CREATE INDEX idx_employee_name ON employee (name);

SELECT e.name, d.name AS department_name FROM employee e JOIN department d ON e.department_id = d.id;

CREATE VIEW employee_view AS SELECT name, salary FROM employee WHERE salary > 60000;
SELECT * FROM employee_view;
DROP VIEW employee_view;

-- PostgreSQL Specific Features
CREATE OR REPLACE FUNCTION get_employee_count(dept_id INT)
RETURNS INT AS $$
BEGIN
    RETURN (SELECT COUNT(*) FROM employee WHERE department_id = dept_id);
END;
$$ LANGUAGE plpgsql;

SELECT get_employee_count(1);

CREATE TABLE product (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  price NUMERIC(10, 2)
);

INSERT INTO product (name, price) VALUES ('Laptop', 1200.00);
INSERT INTO product (name, price) VALUES ('Mouse', 25.00);

SELECT * FROM product;

-- Using generate_series
SELECT generate_series(1, 5);

-- Using pg_sleep
SELECT pg_sleep(0.1);

-- Conditional expression
SELECT name, CASE WHEN salary > 70000 THEN 'High' ELSE 'Low' END AS salary_level FROM employee;

-- Try JSON functionality
CREATE TABLE json_table (id SERIAL PRIMARY KEY, data JSONB);
INSERT INTO json_table (data) VALUES ('{"name": "Example", "value": 123}');
SELECT data ->> 'name' FROM json_table;

-- Materialized view
CREATE MATERIALIZED VIEW materialized_employee AS SELECT * FROM employee;
REFRESH MATERIALIZED VIEW materialized_employee;

-- window functions
SELECT name, salary, RANK() OVER (ORDER BY salary DESC) FROM employee;

-- Common table expression
WITH SalaryRanks AS (
  SELECT
    name,
    salary,
    RANK() OVER (ORDER BY salary DESC) AS salary_rank
  FROM employee
)
SELECT name, salary FROM SalaryRanks WHERE salary_rank <= 3;

-- Table partitioning
CREATE TABLE sales (
    sale_date DATE NOT NULL,
    region TEXT NOT NULL,
    amount NUMERIC
) PARTITION BY RANGE (sale_date);

CREATE TABLE sales_y2023m01 PARTITION OF sales
    FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');