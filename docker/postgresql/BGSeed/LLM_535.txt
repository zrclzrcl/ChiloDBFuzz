CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE
);

CREATE TABLE product_categories (
    product_id INTEGER REFERENCES products(id),
    category_id INTEGER REFERENCES categories(id),
    PRIMARY KEY (product_id, category_id)
);

INSERT INTO categories (name) VALUES ('Electronics'), ('Books'), ('Clothing');

INSERT INTO products (name, price, description) VALUES
    ('Laptop', 1200.00, 'High-performance laptop'),
    ('Database Systems Textbook', 75.00, 'Comprehensive guide to databases'),
    ('T-Shirt', 25.00, 'Comfortable cotton t-shirt');

INSERT INTO product_categories (product_id, category_id) VALUES
    (1, 1),
    (2, 2),
    (3, 3);

SELECT * FROM products WHERE price > 50.00;

SELECT name, price FROM products ORDER BY price DESC LIMIT 2;

UPDATE products SET price = 1300.00 WHERE name = 'Laptop';

DELETE FROM products WHERE name = 'T-Shirt';

SELECT p.name, p.price, c.name AS category
FROM products p
JOIN product_categories pc ON p.id = pc.product_id
JOIN categories c ON pc.category_id = c.id;

CREATE INDEX idx_products_name ON products (name);

EXPLAIN SELECT * FROM products WHERE name = 'Laptop';

SELECT COUNT(*) FROM products;

SELECT AVG(price) FROM products;

SELECT MAX(price) FROM products;

SELECT MIN(price) FROM products;

SELECT SUM(price) FROM products;

SELECT name, LENGTH(description) FROM products;

SELECT UPPER(name), LOWER(name) FROM products;

SELECT SUBSTRING(description, 1, 20) FROM products;

SELECT TRIM(description) FROM products;

SELECT name FROM products WHERE description LIKE '%database%';

SELECT name FROM products WHERE description ILIKE '%laptop%';

SELECT name FROM products WHERE price BETWEEN 50 AND 1500;

SELECT name FROM products WHERE id IN (SELECT product_id FROM product_categories WHERE category_id = 1);

SELECT EXISTS (SELECT 1 FROM products WHERE price > 1000);

SELECT CURRENT_TIMESTAMP;

SELECT NOW();

SELECT pg_typeof(id) FROM products;

--Test window functions
SELECT
    name,
    price,
    RANK() OVER (ORDER BY price DESC) as price_rank
FROM products;

--Test common table expressions
WITH ExpensiveProducts AS (
    SELECT name, price
    FROM products
    WHERE price > 100
)
SELECT * FROM ExpensiveProducts;

--Test user defined functions
CREATE OR REPLACE FUNCTION get_product_count()
RETURNS INTEGER AS $$
BEGIN
    RETURN (SELECT COUNT(*) FROM products);
END;
$$ LANGUAGE plpgsql;

SELECT get_product_count();

--Test array
ALTER TABLE products ADD COLUMN tags TEXT[];
UPDATE products SET tags = ARRAY['new', 'featured'] WHERE name = 'Laptop';
SELECT tags FROM products WHERE name = 'Laptop';