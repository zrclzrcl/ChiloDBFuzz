CREATE TABLE products (
    product_no integer,
    name text,
    price numeric
);

CREATE FUNCTION tax(numeric) RETURNS numeric
    AS 'SELECT $1 * 0.20;'
    LANGUAGE SQL
    IMMUTABLE
    RETURNS NULL ON NULL INPUT;

CREATE TABLE orders (
    order_id integer GENERATED BY DEFAULT AS IDENTITY,
    product_no integer REFERENCES products,
    quantity integer
);

INSERT INTO products (product_no, name, price) VALUES
    (1, 'Cheese', 9.99),
    (2, 'Bread', 1.49),
    (3, 'Milk', 2.99);

INSERT INTO orders (product_no, quantity) VALUES
    (1, 2),
    (2, 1),
    (3, 3);

SELECT order_id, product_no, quantity FROM orders;

SELECT name, price, tax(price) FROM products WHERE price > 5;

CREATE VIEW order_details AS
SELECT o.order_id, p.name, o.quantity, p.price, tax(p.price) AS tax
FROM orders o
JOIN products p ON o.product_no = p.product_no;

SELECT * FROM order_details;

CREATE TABLE employees (
    emp_id integer PRIMARY KEY,
    emp_name text,
    dept_name text,
    salary numeric
);

INSERT INTO employees (emp_id, emp_name, dept_name, salary) VALUES
    (101, 'Alice', 'Sales', 60000),
    (102, 'Bob', 'Marketing', 75000),
    (103, 'Charlie', 'Sales', 62000),
    (104, 'David', 'Engineering', 90000);

SELECT dept_name, AVG(salary) FROM employees GROUP BY dept_name;

CREATE INDEX emp_dept_idx ON employees (dept_name);

ALTER TABLE products ADD COLUMN description text;

UPDATE products SET description = 'Delicious cheese from France' WHERE product_no = 1;

DELETE FROM products WHERE product_no = 3;

SELECT * FROM products;

CREATE TABLE inventory (
    product_no integer REFERENCES products,
    quantity integer CHECK (quantity >= 0)
);

INSERT INTO inventory (product_no, quantity) VALUES
    (1, 50),
    (2, 100);

CREATE OR REPLACE FUNCTION update_inventory(p_product_no integer, p_quantity integer)
RETURNS void AS $$
BEGIN
    UPDATE inventory SET quantity = quantity + p_quantity WHERE product_no = p_product_no;
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Product % not found in inventory', p_product_no;
    END IF;
END;
$$ LANGUAGE plpgsql;

SELECT update_inventory(1, -10);

SELECT * FROM inventory;

CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);

INSERT INTO users (username, email) VALUES
    ('john_doe', 'john.doe@example.com'),
    ('jane_smith', 'jane.smith@example.com');

SELECT * FROM users;

CREATE TEMPORARY TABLE temp_products AS SELECT * FROM products;

SELECT * FROM temp_products;

DROP TABLE IF EXISTS temp_products;

CREATE TYPE address AS (
    street VARCHAR(100),
    city VARCHAR(50),
    zipcode VARCHAR(10)
);

CREATE TABLE addresses (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id),
    address_data address
);

INSERT INTO addresses (user_id, address_data) VALUES
    (1, ROW('123 Main St', 'Anytown', '12345')::address);

SELECT (address_data).street, (address_data).city FROM addresses;

CREATE DOMAIN us_postal_code AS TEXT
CHECK (VALUE ~ '^\d{5}(-\d{4})?$');

CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    postal_code us_postal_code
);

INSERT INTO customers (postal_code) VALUES ('12345');
INSERT INTO customers (postal_code) VALUES ('12345-6789');

CREATE SEQUENCE my_sequence START 100 INCREMENT BY 5;

SELECT nextval('my_sequence');
SELECT currval('my_sequence');
SELECT lastval();

CREATE TABLE log_table (
    log_id BIGSERIAL PRIMARY KEY,
    log_message TEXT,
    log_time TIMESTAMPTZ DEFAULT NOW()
);

INSERT INTO log_table (log_message) VALUES ('System started');

SELECT * FROM log_table;

CREATE COLLATION german (locale = 'de_DE');

CREATE TABLE collated_table (
    id SERIAL PRIMARY KEY,
    name TEXT COLLATE german
);

INSERT INTO collated_table (name) VALUES ('Ã¤bc'), ('abc');

SELECT name FROM collated_table ORDER BY name;