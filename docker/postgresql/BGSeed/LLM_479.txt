CREATE TABLE test_table (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    age INT,
    data JSONB
);

INSERT INTO test_table (name, age, data) VALUES
('Alice', 30, '{"city": "New York", "occupation": "Engineer"}'),
('Bob', 25, '{"city": "Los Angeles", "occupation": "Doctor"}'),
('Charlie', 40, '{"city": "Chicago", "occupation": "Teacher"}');

SELECT * FROM test_table WHERE age > 28;

UPDATE test_table SET age = 31 WHERE name = 'Alice';

DELETE FROM test_table WHERE name = 'Charlie';

SELECT jsonb_pretty(data) FROM test_table;

SELECT name, data ->> 'city' AS city FROM test_table;

SELECT avg(age) FROM test_table;

CREATE INDEX idx_name ON test_table (name);

EXPLAIN SELECT * FROM test_table WHERE name = 'Alice';

SELECT version();

-- Use of generate_series
SELECT generate_series(1, 10);

-- Use of window functions
SELECT name, age, RANK() OVER (ORDER BY age DESC) FROM test_table;

-- Create a temporary table
CREATE TEMP TABLE temp_table AS SELECT * FROM test_table WHERE age > 25;

SELECT * FROM temp_table;

DROP TABLE temp_table;

-- Using CTE
WITH OlderPeople AS (
    SELECT * FROM test_table WHERE age > 30
)
SELECT name FROM OlderPeople;

-- More complex JSONB operations
INSERT INTO test_table (name, age, data) VALUES ('David', 35, '{"skills": ["SQL", "Python", "Java"]}');

SELECT name, data -> 'skills' FROM test_table WHERE data ->> 'skills' LIKE '%SQL%';

-- Using ILIKE for case-insensitive search
SELECT * FROM test_table WHERE name ILIKE 'a%';

-- Using DISTINCT
SELECT DISTINCT age FROM test_table;

-- Using GROUP BY and HAVING
SELECT age, COUNT(*) FROM test_table GROUP BY age HAVING COUNT(*) > 0;

-- Using UNION ALL
SELECT name FROM test_table WHERE age > 30 UNION ALL SELECT name FROM test_table WHERE name LIKE 'B%';

-- Using CASE WHEN
SELECT name,
       CASE
           WHEN age < 30 THEN 'Young'
           WHEN age >= 30 AND age < 40 THEN 'Middle-aged'
           ELSE 'Old'
       END AS age_group
FROM test_table;

-- Create a function (simple example)
CREATE OR REPLACE FUNCTION greet(name VARCHAR) RETURNS VARCHAR AS $$
BEGIN
    RETURN 'Hello, ' || name || '!';
END;
$$ LANGUAGE plpgsql;

SELECT greet('World');

DROP FUNCTION greet(VARCHAR);

-- привилегии для пользователя
CREATE ROLE test_user WITH LOGIN PASSWORD 'password';
GRANT SELECT ON test_table TO test_user;

-- REVOKE SELECT ON test_table FROM test_user;
DROP ROLE test_user;

DROP TABLE test_table;