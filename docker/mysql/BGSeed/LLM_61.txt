SET SQL_MODE = 'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;

CREATE TABLE products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    quantity INT UNSIGNED NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE customers (
    customer_id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255),
    email VARCHAR(255) UNIQUE,
    phone_number VARCHAR(20),
    address TEXT
);

CREATE TABLE orders (
    order_id INT AUTO_INCREMENT PRIMARY KEY,
    customer_id INT,
    order_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(12, 2),
    status ENUM('pending', 'processing', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending',
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
);

CREATE TABLE order_items (
    order_item_id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT UNSIGNED NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

INSERT INTO products (name, description, price, quantity) VALUES
('Awesome T-Shirt', 'A stylish t-shirt for everyday wear', 25.99, 100),
('Comfortable Jeans', 'Classic blue jeans for a casual look', 59.99, 50),
('Running Shoes', 'High-performance shoes for running', 89.99, 75),
('Laptop Backpack', 'Durable backpack for laptops and accessories', 49.99, 30);

INSERT INTO customers (first_name, last_name, email, phone_number, address) VALUES
('John', 'Doe', 'john.doe@example.com', '555-123-4567', '123 Main St, Anytown'),
('Jane', 'Smith', 'jane.smith@example.com', '555-987-6543', '456 Oak Ave, Anytown'),
('David', 'Lee', 'david.lee@example.com', '555-555-1212', '789 Pine Ln, Anytown');

INSERT INTO orders (customer_id, total_amount, status) VALUES
(1, 111.97, 'processing'),  -- (1 * 25.99) + (1 * 89.99)
(2, 119.98, 'shipped'),      -- (2 * 59.99)
(3, 49.99, 'delivered');    -- (1 * 49.99)

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
(1, 1, 1, 25.99),
(1, 3, 1, 89.99),
(2, 2, 2, 59.99),
(3, 4, 1, 49.99);

-- Test GROUP_CONCAT with distinct and separator
SELECT GROUP_CONCAT(DISTINCT name ORDER BY name SEPARATOR ', ') AS distinct_products FROM products;

-- Test window function (ROW_NUMBER)
SELECT name, price, ROW_NUMBER() OVER (ORDER BY price DESC) as row_num FROM products;

-- Test spatial function (requires spatial extensions, so just a placeholder - might cause error, but that's okay for fuzzing)
-- SELECT ST_Distance_Sphere(POINT(-87.6278, 41.8819), POINT(-73.9857, 40.7484));

-- Test JSON functionality (relatively common, but good to include)
SELECT JSON_OBJECT('name', 'Example Product', 'price', 99.99);

-- Test IFNULL and COALESCE
SELECT IFNULL(last_name, 'No Last Name') AS last_name FROM customers;
SELECT COALESCE(last_name, phone_number, 'No Contact Info') AS contact_info FROM customers;

-- Test ENUM type constraints
UPDATE orders SET status = 'cancelled' WHERE order_id = 3;

-- Test generated columns. Requires a table modification since this is a newer MySQL feature.
ALTER TABLE products ADD COLUMN discounted_price DECIMAL(10,2) GENERATED ALWAYS AS (price * 0.9) STORED;

-- Test stored procedure call. May require creating a simple stored procedure beforehand. Intentionally omitted.
-- CALL some_procedure(1, 2);