SET NAMES utf8mb4;
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO products (name, description, price) VALUES
('Awesome Widget', 'A high-quality widget for all your widgeting needs.', 19.99),
('Super Gadget', 'The gadget to end all gadgets!', 99.99),
('Mediocre Thing', 'It exists.', 5.00);

CREATE INDEX idx_product_name ON products (name);

ALTER TABLE products ADD COLUMN discounted_price DECIMAL(10, 2) AFTER price;
UPDATE products SET discounted_price = price * 0.9 WHERE price > 50;

CREATE VIEW discounted_products AS
SELECT id, name, price, discounted_price
FROM products
WHERE discounted_price IS NOT NULL;

SELECT * FROM discounted_products;

-- MySQL-specific: Using JSON functions
ALTER TABLE products ADD COLUMN attributes JSON;
UPDATE products SET attributes = '{"color": "red", "size": "medium"}' WHERE id = 1;
SELECT id, name, attributes->'$.color' AS color FROM products;

-- MySQL-specific: Spatial data types
CREATE TABLE cities (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255),
    location POINT SRID 0
);
INSERT INTO cities (name, location) VALUES ('New York', ST_GeomFromText('POINT(40.7128 -74.0060)'));

-- Test case sensitivity
CREATE TABLE `MixedCaseTable` (`MixedCaseColumn` INT);
INSERT INTO `MixedCaseTable` (`MixedCaseColumn`) VALUES (1);
SELECT `MixedCaseColumn` FROM `MixedCaseTable`;

-- Test generated column functionality.
ALTER TABLE products ADD COLUMN cost DECIMAL(10, 2) AFTER discounted_price;
UPDATE products SET cost = price * 0.5;
ALTER TABLE products ADD COLUMN profit DECIMAL(10, 2) GENERATED ALWAYS AS (price - cost) STORED;

SELECT * FROM products;

-- Test partitioning (if the server supports it - useful for edge cases)
CREATE TABLE sales (
    sale_date DATE,
    product_id INT,
    amount DECIMAL(10, 2)
)
PARTITION BY RANGE ( YEAR(sale_date) ) (
    PARTITION p0 VALUES LESS THAN (2023),
    PARTITION p1 VALUES LESS THAN (2024),
    PARTITION p2 VALUES LESS THAN (2025)
);

INSERT INTO sales (sale_date, product_id, amount) VALUES ('2022-01-01', 1, 10.00), ('2023-01-01', 2, 20.00), ('2024-01-01', 3, 30.00);

EXPLAIN SELECT * FROM sales WHERE sale_date BETWEEN '2023-01-01' AND '2023-12-31';

TRUNCATE TABLE sales;

DROP TABLE cities;
DROP TABLE `MixedCaseTable`;
DROP VIEW discounted_products;
DROP TABLE products;