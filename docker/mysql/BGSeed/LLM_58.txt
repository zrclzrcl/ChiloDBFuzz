SET @old_sql_mode=@@sql_mode, sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';
CREATE TABLE t1 (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    age INT,
    email VARCHAR(255) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO t1 (name, age, email) VALUES
('Alice', 30, 'alice@example.com'),
('Bob', 25, 'bob@example.com'),
('Charlie', 40, 'charlie@example.com');

CREATE TABLE t2 (
    product_id INT PRIMARY KEY AUTO_INCREMENT,
    product_name VARCHAR(255) NOT NULL,
    price DECIMAL(10, 2)
);

INSERT INTO t2 (product_name, price) VALUES
('Laptop', 1200.50),
('Mouse', 25.00),
('Keyboard', 75.25);

CREATE TABLE t3 (
  order_id INT PRIMARY KEY AUTO_INCREMENT,
  customer_id INT,
  product_id INT,
  quantity INT,
  order_date DATE,
  FOREIGN KEY (customer_id) REFERENCES t1(id),
  FOREIGN KEY (product_id) REFERENCES t2(product_id)
);

INSERT INTO t3 (customer_id, product_id, quantity, order_date) VALUES
(1, 1, 2, '2023-01-15'),
(2, 2, 1, '2023-02-20'),
(3, 3, 3, '2023-03-10');

-- Add index to improve query performance
CREATE INDEX idx_customer_id ON t3(customer_id);

-- Stored Procedure example
DELIMITER //
CREATE PROCEDURE GetCustomerOrders(IN customerId INT)
BEGIN
    SELECT * FROM t3 WHERE customer_id = customerId;
END //
DELIMITER ;

-- Call Stored Procedure
CALL GetCustomerOrders(1);

-- View example
CREATE VIEW CustomerOrderView AS
SELECT t1.name, t2.product_name, t3.quantity
FROM t3
JOIN t1 ON t3.customer_id = t1.id
JOIN t2 ON t3.product_id = t2.product_id;

SELECT * FROM CustomerOrderView;

-- Trigger example
DELIMITER //
CREATE TRIGGER before_order_insert
BEFORE INSERT ON t3
FOR EACH ROW
BEGIN
    IF NEW.quantity <= 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Quantity must be greater than zero';
    END IF;
END //
DELIMITER ;

-- Test Trigger (This will throw an error)
-- INSERT INTO t3 (customer_id, product_id, quantity, order_date) VALUES (1, 1, 0, '2024-01-01');

-- User Defined Function example (MySQL 8.0+)
-- CREATE FUNCTION calculate_total_price (quantity INT, price DECIMAL(10,2))
-- RETURNS DECIMAL(10,2) DETERMINISTIC
-- RETURN quantity * price;

-- SELECT calculate_total_price(2, 1200.50);

-- Add a FULLTEXT index
ALTER TABLE t1 ADD FULLTEXT INDEX name_fulltext (name);
SELECT * FROM t1 WHERE MATCH(name) AGAINST ('Alice' IN NATURAL LANGUAGE MODE);

-- Test JSON capabilities
ALTER TABLE t1 ADD COLUMN address JSON;
UPDATE t1 SET address = JSON_OBJECT('street', '123 Main St', 'city', 'Anytown', 'zip', '12345') WHERE id = 1;
SELECT name, address->>'$.city' AS city FROM t1;

-- Test Window Function (MySQL 8.0+)
SELECT
    product_name,
    price,
    RANK() OVER (ORDER BY price DESC) AS price_rank
FROM t2;

SET sql_mode=@old_sql_mode;