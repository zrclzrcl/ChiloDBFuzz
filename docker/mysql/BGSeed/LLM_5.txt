CREATE TABLE employees (
    id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    salary DECIMAL(10, 2),
    department_id INT
);

CREATE TABLE departments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    location VARCHAR(50)
);

ALTER TABLE employees ADD FOREIGN KEY (department_id) REFERENCES departments(id);

INSERT INTO departments (name, location) VALUES ('Sales', 'New York');
INSERT INTO departments (name, location) VALUES ('Marketing', 'London');
INSERT INTO departments (name, location) VALUES ('Engineering', 'San Francisco');

INSERT INTO employees (first_name, last_name, salary, department_id) VALUES ('John', 'Doe', 60000.00, 1);
INSERT INTO employees (first_name, last_name, salary, department_id) VALUES ('Jane', 'Smith', 75000.00, 2);
INSERT INTO employees (first_name, last_name, salary, department_id) VALUES ('Robert', 'Jones', 90000.00, 3);
INSERT INTO employees (first_name, last_name, salary, department_id) VALUES ('Michael', 'Brown', 65000.00, 1);

-- Example of a window function with filtering (MySQL 8+)
SELECT first_name, last_name, salary,
       AVG(salary) OVER (PARTITION BY department_id) as avg_dept_salary
FROM employees
WHERE salary > 60000;

-- Example of a CTE (Common Table Expression)
WITH HighEarners AS (
    SELECT first_name, last_name
    FROM employees
    WHERE salary > 70000
)
SELECT * FROM HighEarners;

-- Example of using JSON functions (MySQL 5.7+)
ALTER TABLE departments ADD COLUMN metadata JSON;
UPDATE departments SET metadata = JSON_OBJECT('headcount', 10, 'budget', 100000) WHERE id = 1;
SELECT name, JSON_EXTRACT(metadata, '$.headcount') AS headcount FROM departments;