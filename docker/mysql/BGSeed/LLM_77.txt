CREATE TABLE employees (
    id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone_number VARCHAR(20),
    hire_date DATE NOT NULL,
    job_id INT,
    salary DECIMAL(10, 2) NOT NULL,
    commission_pct DECIMAL(4, 2),
    department_id INT,
    INDEX salary_index (salary) USING BTREE
);

CREATE TABLE departments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    location_id INT
);

ALTER TABLE employees ADD FOREIGN KEY (department_id) REFERENCES departments(id);

-- Add a spatial index
ALTER TABLE departments ADD COLUMN location POINT SRID 0;
CREATE SPATIAL INDEX location_spacial_index ON departments (location);

-- Insert some initial data
INSERT INTO departments (name, location) VALUES ('Sales', ST_GeomFromText('POINT(10 10)'));
INSERT INTO departments (name, location) VALUES ('Marketing', ST_GeomFromText('POINT(20 20)'));
INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES
('John', 'Doe', 'john.doe@example.com', '2022-01-01', 1, 60000.00, 1),
('Jane', 'Smith', 'jane.smith@example.com', '2022-02-15', 2, 75000.00, 2);

-- Test window functions
SELECT first_name, salary,
       RANK() OVER (ORDER BY salary DESC) as salary_rank
FROM employees;

-- Test JSON functions
ALTER TABLE employees ADD COLUMN metadata JSON;
UPDATE employees SET metadata = JSON_OBJECT('bonus', 1000, 'performance', 'Excellent') WHERE first_name = 'John';
SELECT first_name, JSON_EXTRACT(metadata, '$.bonus') FROM employees;

-- Test GIS functions
SELECT name, ST_Distance(location, ST_GeomFromText('POINT(15 15)')) AS distance FROM departments;

-- Test fulltext index
ALTER TABLE employees ADD FULLTEXT INDEX name_fulltext (first_name, last_name);
SELECT * FROM employees WHERE MATCH (first_name, last_name) AGAINST ('John');

-- Test stored procedure
DELIMITER //
CREATE PROCEDURE GetEmployeeCountByDepartment(IN dept_id INT, OUT employee_count INT)
BEGIN
    SELECT COUNT(*) INTO employee_count FROM employees WHERE department_id = dept_id;
END //
DELIMITER ;

CALL GetEmployeeCountByDepartment(1, @count);
SELECT @count;

-- Test user-defined function
DELIMITER //
CREATE FUNCTION CalculateBonus(salary DECIMAL(10,2))
RETURNS DECIMAL(10,2)
DETERMINISTIC
BEGIN
    RETURN salary * 0.1;
END //
DELIMITER ;

SELECT first_name, salary, CalculateBonus(salary) AS bonus FROM employees;

-- Test EXPLAIN FORMAT=JSON
EXPLAIN FORMAT=JSON SELECT * FROM employees WHERE salary > 50000;

-- Test generated column
ALTER TABLE employees ADD COLUMN full_name VARCHAR(101) GENERATED ALWAYS AS (CONCAT(first_name, ' ', last_name)) STORED;

SHOW CREATE TABLE employees;
SHOW CREATE TABLE departments;

-- Test Common Table Expressions (CTEs)
WITH HighSalaries AS (
    SELECT first_name, salary
    FROM employees
    WHERE salary > 70000
)
SELECT first_name, salary
FROM HighSalaries
ORDER BY salary DESC;

-- Test optimizer hints
SELECT /*+ NO_RANGE_OPTIMIZATION(employees PRIMARY) */ * FROM employees WHERE id = 1;

-- Test locking
LOCK TABLE employees WRITE;
UNLOCK TABLES;