SET sql_mode = 'NO_ENGINE_SUBSTITUTION';

-- Create a table with various data types and constraints
CREATE TABLE employees (
    employee_id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone_number VARCHAR(20),
    hire_date DATE NOT NULL,
    job_id INT,
    salary DECIMAL(10, 2) NOT NULL,
    commission_pct DECIMAL(4, 2),
    manager_id INT,
    department_id INT
) ENGINE=InnoDB;

-- Create a departments table
CREATE TABLE departments (
    department_id INT PRIMARY KEY AUTO_INCREMENT,
    department_name VARCHAR(50) NOT NULL,
    location_id INT
) ENGINE=InnoDB;

-- Create a jobs table
CREATE TABLE jobs (
    job_id INT PRIMARY KEY AUTO_INCREMENT,
    job_title VARCHAR(50) NOT NULL,
    min_salary DECIMAL(10, 2),
    max_salary DECIMAL(10, 2)
) ENGINE=InnoDB;

-- Add foreign key constraints
ALTER TABLE employees ADD FOREIGN KEY (job_id) REFERENCES jobs(job_id);
ALTER TABLE employees ADD FOREIGN KEY (department_id) REFERENCES departments(department_id);
ALTER TABLE employees ADD FOREIGN KEY (manager_id) REFERENCES employees(employee_id);


-- Insert some sample data
INSERT INTO jobs (job_title, min_salary, max_salary) VALUES
('Software Engineer', 60000, 120000),
('Data Scientist', 70000, 130000),
('Project Manager', 80000, 150000);

INSERT INTO departments (department_name) VALUES
('Engineering'),
('Data Science'),
('Management');

INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES
('John', 'Doe', 'john.doe@example.com', '2022-01-15', 1, 80000, 1),
('Jane', 'Smith', 'jane.smith@example.com', '2022-02-20', 2, 90000, 2),
('Peter', 'Jones', 'peter.jones@example.com', '2022-03-10', 3, 100000, 3);

-- Create a view
CREATE VIEW employee_details AS
SELECT e.first_name, e.last_name, d.department_name, j.job_title, e.salary
FROM employees e
JOIN departments d ON e.department_id = d.department_id
JOIN jobs j ON e.job_id = j.job_id;

-- Example stored procedure
DELIMITER //
CREATE PROCEDURE GetEmployeeSalary(IN emp_id INT, OUT salary DECIMAL(10, 2))
BEGIN
    SELECT salary INTO salary FROM employees WHERE employee_id = emp_id;
END //
DELIMITER ;

-- Example function
DELIMITER //
CREATE FUNCTION CalculateBonus(salary DECIMAL(10, 2), bonus_percentage DECIMAL(4, 2))
RETURNS DECIMAL(10, 2)
DETERMINISTIC
BEGIN
    DECLARE bonus DECIMAL(10, 2);
    SET bonus = salary * bonus_percentage;
    RETURN bonus;
END //
DELIMITER ;

-- Use the stored procedure and function
CALL GetEmployeeSalary(1, @salary);
SELECT @salary;
SELECT CalculateBonus(80000, 0.10);

-- Example trigger (BEFORE INSERT to validate email format)
DELIMITER //
CREATE TRIGGER ValidateEmail BEFORE INSERT ON employees
FOR EACH ROW
BEGIN
    IF NEW.email NOT LIKE '%@%.%' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Invalid email format';
    END IF;
END //
DELIMITER ;

-- Test the trigger (this should fail)
-- INSERT INTO employees (first_name, last_name, email, hire_date, job_id, salary, department_id) VALUES ('Test', 'User', 'invalidemail', '2023-01-01', 1, 50000, 1);

-- Example of using window function
SELECT
    employee_id,
    first_name,
    salary,
    department_id,
    RANK() OVER (PARTITION BY department_id ORDER BY salary DESC) as salary_rank
FROM employees;

-- Example FULLTEXT index and search
ALTER TABLE employees ADD FULLTEXT(first_name, last_name, email);
SELECT * FROM employees WHERE MATCH(first_name, last_name, email) AGAINST ('John');

-- Add a spatial index
ALTER TABLE departments ADD location POINT SRID 0;
UPDATE departments SET location = ST_GeomFromText('POINT(10 10)') WHERE department_id = 1;
CREATE SPATIAL INDEX sp_location ON departments (location);

-- Create a user with limited permissions
CREATE USER 'fuzz_user'@'localhost' IDENTIFIED BY 'fuzz_password';
GRANT SELECT ON employee_details TO 'fuzz_user'@'localhost';
FLUSH PRIVILEGES;

-- Test JSON functionality (MySQL 5.7 and above)
ALTER TABLE employees ADD COLUMN profile JSON;
UPDATE employees SET profile = JSON_OBJECT('age', 30, 'city', 'New York') WHERE employee_id = 1;
SELECT employee_id, profile->>'$.city' AS city FROM employees;

-- ANALYZE TABLE to improve query performance
ANALYZE TABLE employees, departments, jobs;

-- Create table with generated columns (MySQL 5.7 and above)
CREATE TABLE rectangle (
    id INT PRIMARY KEY,
    width INT,
    height INT,
    area INT AS (width * height)
);

INSERT INTO rectangle (id, width, height) VALUES (1, 10, 5);
SELECT * FROM rectangle;