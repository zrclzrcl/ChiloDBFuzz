SET @old_sql_mode=@@sql_mode;
SET sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';

CREATE TABLE products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    quantity INT UNSIGNED NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX (name),
    FULLTEXT (description)
) ENGINE=InnoDB;

INSERT INTO products (name, description, price, quantity) VALUES
('Awesome Widget', 'This widget is super awesome and does everything!', 19.99, 100),
('Deluxe Gadget', 'The gadget you always wanted, now in deluxe edition.', 49.99, 50),
('Basic Thingy', 'A simple thingy for everyday use.', 9.99, 200),
('Premium Gizmo', 'The ultimate gizmo for power users.', 99.99, 25);

CREATE TABLE customers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    city VARCHAR(255),
    state VARCHAR(255),
    zip_code VARCHAR(10),
    country VARCHAR(255) DEFAULT 'USA'
) ENGINE=InnoDB;

INSERT INTO customers (first_name, last_name, email, phone, address, city, state, zip_code) VALUES
('John', 'Doe', 'john.doe@example.com', '555-123-4567', '123 Main St', 'Anytown', 'CA', '91234'),
('Jane', 'Smith', 'jane.smith@example.com', '555-987-6543', '456 Oak Ave', 'Springfield', 'IL', '62704');

CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    customer_id INT NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total DECIMAL(10, 2) NOT NULL,
    status ENUM('pending', 'processing', 'shipped', 'delivered', 'canceled') DEFAULT 'pending',
    FOREIGN KEY (customer_id) REFERENCES customers(id)
) ENGINE=InnoDB;

INSERT INTO orders (customer_id, total, status) VALUES
(1, 39.98, 'processing'),
(2, 109.98, 'shipped');

CREATE TABLE order_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT UNSIGNED NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
) ENGINE=InnoDB;

INSERT INTO order_items (order_id, product_id, quantity, price) VALUES
(1, 1, 2, 19.99),
(2, 2, 1, 49.99),
(2, 4, 1, 59.99);

-- Test some edge cases and functionality
SELECT * FROM products WHERE price > 50 ORDER BY price DESC LIMIT 1;
SELECT description FROM products WHERE MATCH (description) AGAINST ('widget');
UPDATE products SET quantity = quantity - 1 WHERE id = 1;
DELETE FROM customers WHERE id = 2; -- Deletes Jane Smith.

-- Test temporal data
SELECT * FROM orders WHERE order_date BETWEEN NOW() - INTERVAL 1 MONTH AND NOW();

-- Test JSON support (MySQL 5.7+) - Adding a JSON column
ALTER TABLE products ADD COLUMN details JSON;
UPDATE products SET details = JSON_OBJECT('color', 'red', 'size', 'medium') WHERE id = 1;
SELECT id, details->'$.color' AS product_color FROM products;

-- Test stored procedure
DELIMITER //
CREATE PROCEDURE GetProductPrice (IN product_name VARCHAR(255), OUT product_price DECIMAL(10, 2))
BEGIN
    SELECT price INTO product_price FROM products WHERE name = product_name;
END //
DELIMITER ;

CALL GetProductPrice('Awesome Widget', @price);
SELECT @price;

-- Test Trigger
CREATE TABLE product_changes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    product_id INT NOT NULL,
    old_price DECIMAL(10, 2),
    new_price DECIMAL(10, 2),
    change_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

DELIMITER //
CREATE TRIGGER product_price_update
BEFORE UPDATE ON products
FOR EACH ROW
BEGIN
    IF NEW.price <> OLD.price THEN
        INSERT INTO product_changes (product_id, old_price, new_price) VALUES (OLD.id, OLD.price, NEW.price);
    END IF;
END //
DELIMITER ;

UPDATE products SET price = 21.99 WHERE id = 1;

SELECT * FROM product_changes;

--Cleanup & Restore SQL Mode
DROP PROCEDURE IF EXISTS GetProductPrice;
DROP TRIGGER IF EXISTS product_price_update;
DROP TABLE IF EXISTS product_changes;

SET sql_mode = @old_sql_mode;