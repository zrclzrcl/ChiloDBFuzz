CREATE TABLE employees (
    id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    salary DECIMAL(10, 2),
    hire_date DATE,
    department_id INT
);

CREATE TABLE departments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50),
    location VARCHAR(50)
);

ALTER TABLE employees ADD FOREIGN KEY (department_id) REFERENCES departments(id);

INSERT INTO departments (name, location) VALUES
('Sales', 'New York'),
('Marketing', 'London'),
('Engineering', 'San Francisco');

INSERT INTO employees (first_name, last_name, salary, hire_date, department_id) VALUES
('John', 'Doe', 60000.00, '2022-01-15', 1),
('Jane', 'Smith', 75000.00, '2021-05-20', 2),
('Peter', 'Jones', 90000.00, '2020-11-01', 3);

-- Test window functions
SELECT
    first_name,
    salary,
    department_id,
    RANK() OVER (PARTITION BY department_id ORDER BY salary DESC) as salary_rank
FROM
    employees;

-- Test stored procedure with error handling
DELIMITER //
CREATE PROCEDURE update_salary (IN emp_id INT, IN new_salary DECIMAL(10,2))
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 'An error occurred, salary update rolled back.';
    END;

    START TRANSACTION;
    UPDATE employees SET salary = new_salary WHERE id = emp_id;
    SELECT * FROM employees WHERE id = emp_id;
    COMMIT;
END //
DELIMITER ;

CALL update_salary(1, 65000.00);

-- Test index hints (MySQL specific)
SELECT SQL_TINY_RESULT * FROM employees USE INDEX (PRIMARY) WHERE id = 1;

-- Test JSON functionality
SELECT JSON_OBJECT('id', id, 'first_name', first_name) AS employee_json FROM employees WHERE id = 1;

-- Test spatial data (if enabled) - requires spatial extensions to be enabled
-- CREATE TABLE spatial_data (id INT PRIMARY KEY, geom GEOMETRY);
-- INSERT INTO spatial_data (id, geom) VALUES (1, ST_GeomFromText('POINT(1 1)'));
-- SELECT ST_AsText(geom) FROM spatial_data;

-- Test fulltext search (if a fulltext index is present) - Add for covering more functionality
ALTER TABLE employees ADD FULLTEXT INDEX name (first_name,last_name);
SELECT * FROM employees WHERE MATCH (first_name,last_name) AGAINST ('John Doe');

-- Test optimizer hints (MySQL specific)
SELECT /*+ NO_RANGE_OPTIMIZATION(employees PRIMARY) */ * FROM employees WHERE id = 1;

-- Clean up (important for repeated execution in a fuzzing environment)
DROP PROCEDURE IF EXISTS update_salary;
DROP TABLE IF EXISTS employees;
DROP TABLE IF EXISTS departments;