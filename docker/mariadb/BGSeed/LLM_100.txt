SET @old_sql_mode=@@sql_mode;
SET sql_mode = 'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- Test CREATE TABLE variations, including engine-specific options
CREATE TABLE test_table (
    id INT PRIMARY KEY AUTO_INCREMENT,
    data VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
    num DECIMAL(10, 2) DEFAULT 0.00,
    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;

CREATE TABLE test_table2 (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ref_id INT,
    other_data TEXT,
    FOREIGN KEY (ref_id) REFERENCES test_table(id) ON DELETE CASCADE
) ENGINE=MyISAM;

-- Test INSERT statements with various data types and expressions
INSERT INTO test_table (data, num) VALUES ('Initial data', 123.45);
INSERT INTO test_table (data, num) VALUES (REPEAT('A', 200), RAND() * 1000);
INSERT INTO test_table (data) VALUES (NULL);
INSERT INTO test_table2 (ref_id, other_data) SELECT id, 'Related data' FROM test_table WHERE num > 100;

-- Test SELECT statements with joins, aggregations, and subqueries
SELECT t1.data, AVG(t2.id) FROM test_table t1 JOIN test_table2 t2 ON t1.id = t2.ref_id GROUP BY t1.data HAVING COUNT(*) > 1;
SELECT * FROM test_table WHERE id IN (SELECT ref_id FROM test_table2 WHERE other_data LIKE '%data%');
SELECT data, num, ts FROM test_table ORDER BY num DESC LIMIT 10;

-- Test UPDATE and DELETE statements with conditions
UPDATE test_table SET num = num * 1.1 WHERE data LIKE '%data%';
DELETE FROM test_table2 WHERE ref_id NOT IN (SELECT id FROM test_table);

-- Test prepared statements
PREPARE stmt FROM 'SELECT * FROM test_table WHERE data LIKE ?';
SET @search_term = '%Initial%';
EXECUTE stmt USING @search_term;

-- Test stored procedures (requires appropriate permissions)
DELIMITER //
CREATE PROCEDURE GetTestData(IN min_num DECIMAL(10, 2))
BEGIN
    SELECT * FROM test_table WHERE num > min_num;
END //
DELIMITER ;

CALL GetTestData(50.00);

-- Test functions
CREATE FUNCTION CalculateSum(a INT, b INT)
RETURNS INT DETERMINISTIC
BEGIN
  RETURN a + b;
END;

SELECT CalculateSum(5, 10);

-- Test window functions (MariaDB 10.2+)
SELECT data, num, ROW_NUMBER() OVER (ORDER BY num DESC) AS row_num FROM test_table;

-- Test JSON functions (MariaDB 10.2+)
CREATE TABLE test_json (id INT PRIMARY KEY, data JSON);
INSERT INTO test_json (id, data) VALUES (1, '{"name": "John", "age": 30}');
SELECT JSON_EXTRACT(data, '$.name') FROM test_json WHERE id = 1;

-- Test user-defined variables
SET @counter = 0;
SELECT @counter := @counter + 1 AS counter, data FROM test_table;

-- Test common table expressions (CTEs)
WITH RankedData AS (
  SELECT data, num, RANK() OVER (ORDER BY num DESC) AS ranking
  FROM test_table
)
SELECT data, num FROM RankedData WHERE ranking <= 3;

-- Clean up, but in a way that allows the seed to be re-run safely.
DROP PROCEDURE IF EXISTS GetTestData;
DROP FUNCTION IF EXISTS CalculateSum;
DROP TABLE IF EXISTS test_json;
DROP TABLE IF EXISTS test_table2;
DROP TABLE IF EXISTS test_table;

SET sql_mode=@old_sql_mode;