-- MariaDB specific features: Window functions, stored procedures, JSON functions, and temporal tables.
-- Covers basic CRUD, indexes, constraints, and some MariaDB specific syntax.

-- Temporal table creation
CREATE TABLE historical_data (
    id INT PRIMARY KEY,
    data VARCHAR(255),
    valid_from TIMESTAMP(6) GENERATED ALWAYS AS ROW START,
    valid_to TIMESTAMP(6) GENERATED ALWAYS AS ROW END,
    PERIOD FOR system_time (valid_from, valid_to)
) WITH SYSTEM VERSIONING;

INSERT INTO historical_data (id, data) VALUES (1, 'Initial Data');
UPDATE historical_data SET data = 'Updated Data' WHERE id = 1;

-- Basic table with different data types and constraints
CREATE TABLE products (
    product_id INT AUTO_INCREMENT PRIMARY KEY,
    product_name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) CHECK (price > 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Insert some data
INSERT INTO products (product_name, description, price) VALUES
('Laptop', 'High-performance laptop', 1200.50),
('Mouse', 'Wireless mouse', 25.99),
('Keyboard', 'Mechanical keyboard', 75.00);

-- Table with foreign key
CREATE TABLE orders (
    order_id INT AUTO_INCREMENT PRIMARY KEY,
    product_id INT,
    quantity INT,
    order_date DATE,
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);

-- Insert some data with valid order dates
INSERT INTO orders (product_id, quantity, order_date) VALUES
(1, 2, '2023-11-01'),
(2, 5, '2023-11-05'),
(3, 1, '2023-11-10');

-- Window function example
SELECT
    product_name,
    price,
    AVG(price) OVER () AS average_price
FROM products;

-- Stored procedure (simple example)
DELIMITER //
CREATE PROCEDURE GetProductCount()
BEGIN
    SELECT COUNT(*) FROM products;
END //
DELIMITER ;

CALL GetProductCount();

-- JSON function usage
CREATE TABLE json_data (
    id INT PRIMARY KEY,
    data JSON
);

INSERT INTO json_data (id, data) VALUES
(1, '{"name": "John", "age": 30, "city": "New York"}');

SELECT data->>'$.name' AS name FROM json_data WHERE id = 1;

-- Fulltext index and search.
CREATE TABLE articles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255),
    content TEXT,
    FULLTEXT INDEX (title, content)
);

INSERT INTO articles (title, content) VALUES
('MariaDB Fuzzing', 'Techniques for fuzzing MariaDB databases.'),
('SQL Injection', 'Preventing SQL injection attacks is crucial.');

SELECT * FROM articles WHERE MATCH (title, content) AGAINST ('fuzzing');

-- Optimizer hints (MariaDB specific)
SELECT /*+ MAX_EXECUTION_TIME(1000) */ * FROM products WHERE price > 50;

-- Create table using different storage engine
CREATE TABLE t2 (id INT) ENGINE=InnoDB;

-- Create table with spatial data type.
CREATE TABLE spatial_data (id INT, location POINT SRID 0, SPATIAL INDEX(location));
INSERT INTO spatial_data (id, location) VALUES (1, ST_GeomFromText('POINT(1 1)'));

-- Create table and partition it.
CREATE TABLE t3 (id INT, name VARCHAR(255))
PARTITION BY HASH(id)
PARTITIONS 4;

INSERT INTO t3(id, name) VALUES(1, 'a'), (2, 'b'), (3, 'c'), (4, 'd');