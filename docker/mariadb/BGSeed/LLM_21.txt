SET @old_sql_mode=@@sql_mode;
SET sql_mode = 'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';
SET @cte_max_recursion_depth_save = @@cte_max_recursion_depth;
SET @@cte_max_recursion_depth = 255;

-- Test temporal tables (MariaDB 10.3+)
CREATE TABLE history_test (
    id INT PRIMARY KEY,
    value VARCHAR(255),
    start_ts TIMESTAMP GENERATED ALWAYS AS ROW START,
    end_ts TIMESTAMP GENERATED ALWAYS AS ROW END,
    PERIOD FOR system_time (start_ts, end_ts)
) WITH SYSTEM VERSIONING;

INSERT INTO history_test (id, value) VALUES (1, 'initial value');
UPDATE history_test SET value = 'updated value' WHERE id = 1;
SELECT * FROM history_test FOR SYSTEM_TIME ALL;

-- Test window functions
CREATE TABLE window_test (
    category VARCHAR(50),
    value INT
);

INSERT INTO window_test (category, value) VALUES
('A', 10), ('A', 20), ('B', 15), ('B', 25), ('C', 30);

SELECT category, value, ROW_NUMBER() OVER (PARTITION BY category ORDER BY value) AS row_num FROM window_test;

-- Test JSON functions and JSON type (MariaDB 10.2+)
CREATE TABLE json_test (
    id INT PRIMARY KEY,
    data JSON
);

INSERT INTO json_test (id, data) VALUES (1, '{"name": "Alice", "age": 30}');
SELECT id, JSON_EXTRACT(data, '$.name') FROM json_test;
UPDATE json_test SET data = JSON_SET(data, '$.age', 31) WHERE id = 1;

-- Test sequences (MariaDB 10.3+)
CREATE SEQUENCE my_sequence START WITH 10 INCREMENT BY 5;
SELECT SEQ_NEXTVAL(my_sequence);
SELECT SEQ_CURRVAL(my_sequence);

-- Test virtual columns (MariaDB 5.2+)
CREATE TABLE virtual_column_test (
    a INT,
    b INT,
    c INT GENERATED ALWAYS AS (a + b) VIRTUAL
);

INSERT INTO virtual_column_test (a, b) VALUES (10, 20);
SELECT * FROM virtual_column_test;

-- Test stored procedures
DELIMITER //
CREATE PROCEDURE increment(INOUT num INT)
BEGIN
    SET num = num + 1;
END //
DELIMITER ;

SET @my_num = 5;
CALL increment(@my_num);
SELECT @my_num;

-- Test common table expressions (CTEs)
WITH RECURSIVE numbers AS (
  SELECT 1 AS n
  UNION ALL
  SELECT n + 1 FROM numbers WHERE n < 5
)
SELECT * FROM numbers;

-- Cleanup

DROP TABLE IF EXISTS history_test;
DROP TABLE IF EXISTS window_test;
DROP TABLE IF EXISTS json_test;
DROP TABLE IF EXISTS virtual_column_test;
DROP SEQUENCE IF EXISTS my_sequence;

SET sql_mode = @old_sql_mode;
SET @@cte_max_recursion_depth = @cte_max_recursion_depth_save;