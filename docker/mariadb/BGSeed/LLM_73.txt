CREATE TABLE accounts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_number VARCHAR(255) UNIQUE NOT NULL,
    balance DECIMAL(15, 2) NOT NULL DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE transactions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_id INT NOT NULL,
    transaction_type ENUM('deposit', 'withdrawal', 'transfer') NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (account_id) REFERENCES accounts(id)
);

INSERT INTO accounts (account_number, balance) VALUES ('1234567890', 1000.00);
INSERT INTO accounts (account_number, balance) VALUES ('0987654321', 500.00);

INSERT INTO transactions (account_id, transaction_type, amount) VALUES (1, 'deposit', 200.00);
INSERT INTO transactions (account_id, transaction_type, amount) VALUES (2, 'withdrawal', 100.00);

SET @account_id = 1;
SELECT * FROM accounts WHERE id = @account_id;

UPDATE accounts SET balance = balance + 50 WHERE account_number = '1234567890';

-- MariaDB Specific: Use of `ROW_NUMBER()` window function
SELECT
    *,
    ROW_NUMBER() OVER (ORDER BY balance DESC) as row_num
FROM
    accounts;

-- MariaDB Specific:  Using JSON functions
SELECT JSON_OBJECT('id', id, 'account_number', account_number, 'balance', balance) AS account_json FROM accounts WHERE id = 1;

-- MariaDB Specific: Stored Procedure with error handling
DELIMITER //
CREATE PROCEDURE transfer_funds(IN from_account VARCHAR(255), IN to_account VARCHAR(255), IN amount DECIMAL(15, 2))
BEGIN
    DECLARE from_id INT;
    DECLARE to_id INT;

    SELECT id INTO from_id FROM accounts WHERE account_number = from_account;
    SELECT id INTO to_id FROM accounts WHERE account_number = to_account;

    IF from_id IS NULL OR to_id IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid account number';
    END IF;

    UPDATE accounts SET balance = balance - amount WHERE id = from_id;
    UPDATE accounts SET balance = balance + amount WHERE id = to_id;

    INSERT INTO transactions (account_id, transaction_type, amount) VALUES (from_id, 'transfer', -amount);
    INSERT INTO transactions (account_id, transaction_type, amount) VALUES (to_id, 'transfer', amount);

    COMMIT;
END //
DELIMITER ;

CALL transfer_funds('1234567890', '0987654321', 50.00);

ANALYZE TABLE accounts;
ANALYZE TABLE transactions;

OPTIMIZE TABLE accounts;
OPTIMIZE TABLE transactions;

SET GLOBAL general_log = 'OFF';