SET optimizer_switch='semijoin=on,materialization=on,firstmatch=on,loosescan=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=off';
SET @read_rnd_buffer_size_save= @@read_rnd_buffer_size;
SET read_rnd_buffer_size=131072;

CREATE TABLE t1 (
    id INT PRIMARY KEY AUTO_INCREMENT,
    a INT,
    b VARCHAR(255),
    c DATETIME,
    d ENUM('red', 'green', 'blue')
);

INSERT INTO t1 (a, b, c, d) VALUES
(1, 'test1', '2024-01-01 10:00:00', 'red'),
(2, 'test2', '2024-01-02 11:00:00', 'green'),
(3, 'test3', '2024-01-03 12:00:00', 'blue');

CREATE TABLE t2 (
    id INT PRIMARY KEY AUTO_INCREMENT,
    t1_id INT,
    value VARCHAR(255),
    FOREIGN KEY (t1_id) REFERENCES t1(id)
);

INSERT INTO t2 (t1_id, value) VALUES
(1, 'value1'),
(1, 'value2'),
(2, 'value3');

-- MariaDB specific: Sequence example
CREATE SEQUENCE my_seq START WITH 1 INCREMENT BY 1;

INSERT INTO t1 (a, b, c, d) VALUES
(NEXT VALUE FOR my_seq, 'seq_test', NOW(), 'red');

SELECT * FROM t1 WHERE a = LAST_INSERT_ID();

-- MariaDB specific: Virtual column example
ALTER TABLE t1 ADD COLUMN combined VARCHAR(512) GENERATED ALWAYS AS (concat(a, '-', b)) VIRTUAL;

SELECT id, combined FROM t1;

-- Test common functions
SELECT AVG(a), MAX(a), MIN(a) FROM t1;

-- Test some edge cases with date arithmetic
SELECT DATE_ADD(c, INTERVAL 1 DAY), DATE_SUB(c, INTERVAL 1 HOUR) FROM t1;

-- Test JSON functions
ALTER TABLE t1 ADD COLUMN json_data JSON;
UPDATE t1 SET json_data = JSON_OBJECT('key1', a, 'key2', b) WHERE id = 1;
SELECT id, JSON_EXTRACT(json_data, '$.key1') FROM t1;

-- Test Fulltext index
ALTER TABLE t1 ADD FULLTEXT INDEX b_fulltext (b);
SELECT * FROM t1 WHERE MATCH (b) AGAINST ('test1');

-- Cleanup (important for repeated fuzzing)
DROP TABLE IF EXISTS t2;
DROP TABLE IF EXISTS t1;
DROP SEQUENCE IF EXISTS my_seq;