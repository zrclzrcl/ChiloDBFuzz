SET @old_sql_mode=@@sql_mode;
SET sql_mode='STRICT_ALL_TABLES';
SET @old_autocommit=@@autocommit;
SET autocommit = 0;
SET @old_wait_timeout=@@wait_timeout;
SET wait_timeout=600;
SET @old_net_read_timeout=@@net_read_timeout;
SET net_read_timeout=30;
CREATE TABLE t1 (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255),
  age INT,
  email VARCHAR(255)
);

INSERT INTO t1 (name, age, email) VALUES
('Alice', 30, 'alice@example.com'),
('Bob', 25, 'bob@example.com'),
('Charlie', 35, 'charlie@example.com');

CREATE TABLE t2 (
  id INT PRIMARY KEY AUTO_INCREMENT,
  t1_id INT,
  value VARCHAR(255),
  FOREIGN KEY (t1_id) REFERENCES t1(id)
);

INSERT INTO t2 (t1_id, value) VALUES
(1, 'Value 1'),
(2, 'Value 2'),
(3, 'Value 3');

-- Test JSON functionality
SELECT JSON_OBJECT('id', id, 'name', name) FROM t1 WHERE id = 1;

-- Test stored procedure
DELIMITER //
CREATE PROCEDURE GetUser(IN userId INT)
BEGIN
  SELECT * FROM t1 WHERE id = userId;
END //
DELIMITER ;

CALL GetUser(2);

-- Test trigger
CREATE TABLE t1_audit (
  id INT,
  name VARCHAR(255),
  operation VARCHAR(10),
  ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

DELIMITER //
CREATE TRIGGER t1_after_update
AFTER UPDATE ON t1
FOR EACH ROW
BEGIN
  INSERT INTO t1_audit (id, name, operation) VALUES (NEW.id, NEW.name, 'UPDATE');
END //
DELIMITER ;

UPDATE t1 SET name = 'David' WHERE id = 1;

-- Test window function
SELECT name, age, RANK() OVER (ORDER BY age DESC) AS age_rank FROM t1;

-- Test fulltext index
ALTER TABLE t1 ADD FULLTEXT INDEX name_fulltext (name);
SELECT * FROM t1 WHERE MATCH(name) AGAINST('David');

-- Test spatial index (requires appropriate data types and config, kept simple for now)
CREATE TABLE spatial_table (id INT PRIMARY KEY, point POINT);
INSERT INTO spatial_table (id, point) VALUES (1, ST_GeomFromText('POINT(1 1)'));
SELECT ST_AsText(point) FROM spatial_table;

-- Test MariaDB specific feature: SEQUENCE
CREATE SEQUENCE seq_example START WITH 1 INCREMENT BY 1;
SELECT NEXT VALUE FOR seq_example;

-- Test common table expression (CTE)
WITH AvgAges AS (
    SELECT AVG(age) AS avg_age FROM t1
)
SELECT t1.name, t1.age, AvgAges.avg_age
FROM t1, AvgAges
WHERE t1.age > AvgAges.avg_age;

-- Cleanup
DROP PROCEDURE IF EXISTS GetUser;
DROP TRIGGER IF EXISTS t1_after_update;
DROP TABLE IF EXISTS t1_audit;
DROP TABLE IF EXISTS t2;
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS spatial_table;
DROP SEQUENCE IF EXISTS seq_example;

SET sql_mode=@old_sql_mode;
SET autocommit = @old_autocommit;
SET wait_timeout=@old_wait_timeout;
SET net_read_timeout=@old_net_read_timeout;
COMMIT;