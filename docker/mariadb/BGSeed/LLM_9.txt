CREATE TABLE employees (
    emp_id INT PRIMARY KEY,
    emp_name VARCHAR(50) NOT NULL,
    salary DECIMAL(10, 2),
    dept_id INT
);

CREATE TABLE departments (
    dept_id INT PRIMARY KEY,
    dept_name VARCHAR(50)
);

INSERT INTO departments (dept_id, dept_name) VALUES
(1, 'Sales'),
(2, 'Marketing'),
(3, 'Engineering');

INSERT INTO employees (emp_id, emp_name, salary, dept_id) VALUES
(101, 'Alice', 60000.00, 1),
(102, 'Bob', 75000.00, 2),
(103, 'Charlie', 90000.00, 3),
(104, 'David', 65000.00, 1),
(105, 'Eve', 80000.00, 3);

-- MariaDB specific feature: Window functions with IGNORE NULLS
SELECT emp_name, salary,
       AVG(salary) OVER (PARTITION BY dept_id ORDER BY salary ASC IGNORE NULLS) AS avg_dept_salary
FROM employees;

-- MariaDB specific feature: Sequence Usage (if sequence engine is enabled).  Often not, but good for edge cases.
-- CREATE SEQUENCE test_seq START WITH 1 INCREMENT BY 1 MAXVALUE 100 CYCLE; -- Assumes sequence engine is enabled
-- SELECT NEXT VALUE FOR test_seq; -- Sequence engine not commonly used, uncomment at your own risk.
-- Edge case: Trying to insert into a non-nullable column with DEFAULT.
INSERT INTO employees (emp_id, emp_name, salary, dept_id) VALUES (106, DEFAULT, 55000.00, 2); -- This WILL fail because emp_name is NOT NULL. Good for triggering errors.

-- Test JSON functions
SELECT JSON_OBJECT('emp_id', emp_id, 'emp_name', emp_name) AS employee_json FROM employees WHERE dept_id = 1;

-- Test temporal data types
CREATE TABLE audit_log (
    log_id INT PRIMARY KEY AUTO_INCREMENT,
    event_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    description VARCHAR(255)
);

INSERT INTO audit_log (description) VALUES ('Employee Alice updated salary');

SELECT * FROM audit_log;

-- Test stored procedures.
DELIMITER //
CREATE PROCEDURE GetEmployeesByDept(IN deptId INT)
BEGIN
    SELECT emp_name, salary FROM employees WHERE dept_id = deptId;
END //
DELIMITER ;

CALL GetEmployeesByDept(3);

-- Cleanup (important for repeatable fuzzing)
DROP PROCEDURE IF EXISTS GetEmployeesByDept;
DROP TABLE IF EXISTS audit_log;
DROP TABLE IF EXISTS employees;
DROP TABLE IF EXISTS departments;