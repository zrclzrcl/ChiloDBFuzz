SET @old_sql_mode=@@sql_mode;
SET sql_mode = 'STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO';
SET names utf8mb4;

CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    email VARCHAR(255),
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    last_login DATETIME NULL
);

CREATE TABLE IF NOT EXISTS products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    stock INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    order_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(10, 2) NOT NULL,
    status ENUM('pending', 'processing', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending',
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS order_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

-- MariaDB specific:  Using JSON column type
ALTER TABLE products ADD COLUMN attributes JSON;

-- MariaDB specific:  Sequence example
CREATE SEQUENCE IF NOT EXISTS product_id_seq START WITH 1000 INCREMENT BY 1;

-- MariaDB specific: Example using virtual columns.
ALTER TABLE products ADD COLUMN discounted_price DECIMAL(10, 2) AS (price * 0.9) PERSISTENT;

-- Populate some data
INSERT INTO users (username, email, password) VALUES ('testuser1', 'test1@example.com', 'password');
INSERT INTO products (name, price, stock, attributes) VALUES ('Test Product 1', 25.50, 100, '{"color": "red", "size": "medium"}');
INSERT INTO orders (user_id, total_amount) VALUES (1, 25.50);
INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (1, 1, 1, 25.50);

-- Example fulltext index (MariaDB uses myisam for fulltext on older versions)
ALTER TABLE products ENGINE=InnoDB;
CREATE FULLTEXT INDEX idx_products_name_description ON products (name, description);

-- Example stored procedure
DELIMITER //
CREATE PROCEDURE GetProductPrice(IN productId INT, OUT price DECIMAL(10, 2))
BEGIN
    SELECT p.price INTO price FROM products p WHERE p.id = productId;
END //
DELIMITER ;

-- Example trigger
DELIMITER //
CREATE TRIGGER UpdateOrderTotal AFTER INSERT ON order_items
FOR EACH ROW
BEGIN
    UPDATE orders SET total_amount = (SELECT SUM(quantity * price) FROM order_items WHERE order_id = NEW.order_id) WHERE id = NEW.order_id;
END //
DELIMITER ;

ANALYZE TABLE users, products, orders, order_items;

-- Example query using window function
SELECT p.name, p.price,
       RANK() OVER (ORDER BY p.price DESC) as price_rank
FROM products p;

-- Example of using a common table expression (CTE)
WITH HighValueOrders AS (
    SELECT order_id
    FROM order_items
    GROUP BY order_id
    HAVING SUM(quantity * price) > 100
)
SELECT o.*
FROM orders o
JOIN HighValueOrders hvo ON o.id = hvo.order_id;

SHOW INDEXES FROM products;
SHOW TRIGGERS;
SHOW PROCEDURE STATUS LIKE 'GetProductPrice';

SET sql_mode = @old_sql_mode;