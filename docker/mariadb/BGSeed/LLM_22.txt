SET optimizer_switch='derived_merge=off,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,semijoin=on,duplicateweedout=on';
SET @old_sql_mode=@@sql_mode;
SET sql_mode='STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO';
SET NAMES utf8mb4;

CREATE TABLE t1 (
    id INT PRIMARY KEY AUTO_INCREMENT,
    a INT,
    b VARCHAR(255),
    c ENUM('x', 'y', 'z') DEFAULT 'x',
    d TEXT,
    e JSON
);

INSERT INTO t1 (a, b, c, d, e) VALUES
(1, 'hello', 'x', 'world', '{"key1": "value1", "key2": 123}'),
(2, 'goodbye', 'y', 'universe', '{"key3": "value2", "key4": true}'),
(3, NULL, 'z', NULL, NULL);

CREATE TABLE t2 (
    id INT PRIMARY KEY AUTO_INCREMENT,
    t1_id INT,
    value INT,
    FOREIGN KEY (t1_id) REFERENCES t1(id)
);

INSERT INTO t2 (t1_id, value) VALUES
(1, 10),
(1, 20),
(2, 30);

CREATE VIEW v1 AS SELECT t1.id, t1.a, t2.value FROM t1 JOIN t2 ON t1.id = t2.t1_id WHERE t2.value > 15;

DELIMITER //
CREATE PROCEDURE p1(IN input_id INT)
BEGIN
    SELECT * FROM t1 WHERE id = input_id;
END //
DELIMITER ;

CREATE FUNCTION f1(input_a INT) RETURNS INT
DETERMINISTIC
BEGIN
    RETURN input_a * 2;
END;

SELECT * FROM t1 WHERE a > 0 ORDER BY id DESC LIMIT 2;
SELECT * FROM t2 WHERE value < 50;
SELECT id, a, f1(a) FROM t1;
CALL p1(1);
SELECT * FROM v1;

ALTER TABLE t1 ADD COLUMN f TIMESTAMP DEFAULT CURRENT_TIMESTAMP;

UPDATE t1 SET b = 'updated' WHERE id = 1;

DELETE FROM t2 WHERE t1_id = 2;

-- MariaDB specific: test virtual columns
ALTER TABLE t1 ADD COLUMN g INT AS (a * 2) VIRTUAL;

-- MariaDB specific: test sequence
CREATE SEQUENCE seq1 START WITH 1 INCREMENT BY 1 MAXVALUE 100 CYCLE;
SELECT SEQ_NEXTVAL(seq1);
SELECT SEQ_CURRVAL(seq1);

-- Test JSON functions
SELECT JSON_EXTRACT(e, '$.key1') FROM t1 WHERE id = 1;
SELECT JSON_INSERT(e, '$.newKey', 'newValue') FROM t1 WHERE id = 1;

-- Test spatial data types (requires spatial extensions)
CREATE TABLE t3 (id INT PRIMARY KEY, geom GEOMETRY);
INSERT INTO t3 (id, geom) VALUES (1, ST_GeomFromText('POINT(1 1)'));
SELECT ST_AsText(geom) FROM t3;

SET sql_mode=@old_sql_mode;