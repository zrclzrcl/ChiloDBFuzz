CREATE DATABASE IF NOT EXISTS fuzz_db;
USE fuzz_db;

-- Create a simple table
CREATE TABLE IF NOT EXISTS users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Insert some initial data
INSERT INTO users (username, email) VALUES
('testuser1', 'test1@example.com'),
('testuser2', 'test2@example.com'),
('testuser3', 'test3@example.com');

-- Test some MariaDB-specific features

-- Create a sequence (MariaDB specific auto-increment alternative)
CREATE SEQUENCE IF NOT EXISTS my_seq START WITH 1 INCREMENT BY 1;

-- Create a table using dynamic columns
CREATE TABLE IF NOT EXISTS dynamic_data (
    id INT PRIMARY KEY,
    data BLOB
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC;

-- Insert into dynamic table
INSERT INTO dynamic_data (id, data) VALUES (1, COLUMN_CREATE('name', 'John', 'age', 30));

-- Select data using dynamic columns
SELECT id, COLUMN_GET(data, 'name' AS CHAR) AS name, COLUMN_GET(data, 'age' AS SIGNED) AS age FROM dynamic_data;


-- Create a table with JSON column
CREATE TABLE IF NOT EXISTS json_data (
    id INT PRIMARY KEY,
    data JSON
);

-- Insert json data
INSERT INTO json_data (id, data) VALUES (1, '{"name": "Alice", "age": 25}');

-- Select data using JSON functions
SELECT id, data->'$.name', data->'$.age' FROM json_data;

-- Stored procedure that modifies data
DELIMITER //
CREATE PROCEDURE IF NOT EXISTS update_username (IN user_id INT, IN new_username VARCHAR(255))
BEGIN
    UPDATE users SET username = new_username WHERE id = user_id;
END //
DELIMITER ;

CALL update_username(1, 'new_username1');

-- Trigger example
DELIMITER //
CREATE TRIGGER IF NOT EXISTS before_user_insert
BEFORE INSERT ON users
FOR EACH ROW
BEGIN
    SET NEW.created_at = NOW();
END //
DELIMITER ;