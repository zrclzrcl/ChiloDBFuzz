CREATE TABLE test_table (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL,
  value INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;

INSERT INTO test_table (name, value) VALUES ('Alice', 10), ('Bob', 20), ('Charlie', 30);

-- MariaDB specific: Insert with ON DUPLICATE KEY UPDATE
INSERT INTO test_table (id, name, value) VALUES (1, 'Alice-Updated', 15)
ON DUPLICATE KEY UPDATE name = VALUES(name), value = VALUES(value);

-- MariaDB specific: Window function
SELECT name, value, ROW_NUMBER() OVER (ORDER BY value DESC) AS row_num FROM test_table;

-- Common table expression (CTE)
WITH RankedTable AS (
  SELECT name, value, RANK() OVER (ORDER BY value DESC) AS rank_num FROM test_table
)
SELECT name, value FROM RankedTable WHERE rank_num <= 2;

-- Stored procedure (MariaDB supports this)
DELIMITER //
CREATE PROCEDURE GetHighValues(IN threshold INT)
BEGIN
  SELECT name, value FROM test_table WHERE value > threshold;
END //
DELIMITER ;

CALL GetHighValues(15);

-- Trigger
DELIMITER //
CREATE TRIGGER test_table_before_update
BEFORE UPDATE ON test_table
FOR EACH ROW
BEGIN
  IF NEW.value < 0 THEN
    SET NEW.value = 0;
  END IF;
END //
DELIMITER ;

UPDATE test_table SET value = -5 WHERE name = 'Alice-Updated'; -- Value will be set to 0

-- Prepared statement
PREPARE stmt FROM 'SELECT * FROM test_table WHERE name LIKE ?';
SET @name_pattern = 'A%';
EXECUTE stmt USING @name_pattern;
DEALLOCATE PREPARE stmt;

-- FULLTEXT index and search
ALTER TABLE test_table ADD FULLTEXT INDEX name_fulltext (name);
SELECT * FROM test_table WHERE MATCH(name) AGAINST('Alice' IN NATURAL LANGUAGE MODE);

-- ANALYZE TABLE (For optimizer hints, MariaDB specific)
ANALYZE TABLE test_table;

-- JSON functions (MariaDB supports these)
ALTER TABLE test_table ADD COLUMN json_data JSON;
UPDATE test_table SET json_data = JSON_OBJECT('city', 'New York', 'age', (id * 10)) WHERE id = 1;
SELECT id, JSON_EXTRACT(json_data, '$.city') AS city FROM test_table WHERE id = 1;

-- Optimizer hint (MariaDB specific)
SELECT /*+ MAX_EXECUTION_TIME(1000) */ * FROM test_table WHERE value > 0;

DROP PROCEDURE IF EXISTS GetHighValues;
DROP TRIGGER IF EXISTS test_table_before_update;
DROP TABLE IF EXISTS test_table;