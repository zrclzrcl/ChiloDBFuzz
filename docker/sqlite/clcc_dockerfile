FROM ubuntu:22.04
LABEL maintainer="zrcl"

ENV DEBIAN_FRONTEND noninteractive

# common config
RUN apt-get update && apt-get -y install make cmake build-essential vim sudo git tcl8.6 tcl8.6-tdbc-sqlite3\
    clang-15 ninja-build pkg-config clang-format \
    libpq-dev libyaml-cpp-dev lld llvm-15 python3-fire python3-pip && pip3 install openai colorama scipy

RUN mkdir -p /home && \
    groupadd dobigthing && \
    useradd -l -K UMASK=0000 -d /home -g dobigthing dobigthing && \
    chown dobigthing:dobigthing /home

RUN	echo "dobigthing:dobigthing" | chpasswd && usermod -a -G sudo dobigthing
RUN chmod +w /etc/sudoers && \
    echo "%dobigthing   ALL=(ALL:ALL)NOPASSWD:ALL" >> /etc/sudoers && \
    chmod -w /etc/sudoers

USER dobigthing
WORKDIR /home

ADD ./clcc_src/count_feedbackpoint.py  /home/clcc/count_feedbackpoint.py
RUN git clone https://github.com/s3team/Squirrel.git && \
    cd Squirrel && git submodule update --init && rm -rf ./srcs/custom_mutator.cc
ADD ./clcc_src/custom_mutator.cc /home/Squirrel/srcs/custom_mutator.cc
RUN cd Squirrel && cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DSQLITE=ON && \
    cmake --build build -j && \
    cd AFLplusplus/ && git remote add upstream https://github.com/AFLplusplus/AFLplusplus.git && git fetch upstream --tags && \
    git reset --hard v4.34c && LLVM_CONFIG=llvm-config-15 make -j$(nproc)

RUN git clone https://github.com/sqlite/sqlite sqlite3/ && cd sqlite3 && git checkout version-3.30.1 && mkdir bld

WORKDIR /home/sqlite3/bld

ENV CC=/home/Squirrel/AFLplusplus/afl-clang-fast
ENV CXX=/home/Squirrel/AFLplusplus/afl-clang-fast++
RUN ../configure && make -j && make sqlite3.c

ENV AFL_USE_ASAN=1
ENV ASAN_CFLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer \
    -DSQLITE_MAX_LENGTH=128000000 -DSQLITE_MAX_SQL_LENGTH=128000000 \
    -DSQLITE_MAX_MEMORY=25000000 -DSQLITE_PRINTF_PRECISION_LIMIT=1048576 \
    -DSQLITE_DEBUG=1 -DSQLITE_MAX_PAGE_COUNT=16384"
ENV ASAN_LDFLAGS="-fsanitize=address -g"

# 重新编译带 ASAN 的 sqlite3.o
RUN $CC $ASAN_CFLAGS -I. -c sqlite3.c -o sqlite3_asan.o

RUN $CC $CFLAGS -I. -c \
    /home/sqlite3/test/ossfuzz.c -o /home/sqlite3/test/ossfuzz.o
RUN $CC $CFLAGS -I. -c \
    /home/sqlite3/test/ossshell.c -o /home/sqlite3/test/ossshell.o

RUN $CXX $ASAN_LDFLAGS \
    /home/sqlite3/test/ossfuzz.o /home/sqlite3/test/ossshell.o sqlite3_asan.o \
    -o /home/ossfuzz -ldl -pthread
   
ADD ./BGSeed/  /home/Squirrel/data/fuzz_root/set_seed/
ADD ./clcc_src/run_with_no_M.py /home/Squirrel/scripts/utils/clcc_run.py
WORKDIR /home/Squirrel/scripts/utils
#ENTRYPOINT python3 run.py sqlite ../../data/fuzz_root/input121
