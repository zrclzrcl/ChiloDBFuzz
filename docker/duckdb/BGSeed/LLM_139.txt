CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    name VARCHAR,
    price DECIMAL(10, 2),
    category VARCHAR
);

INSERT INTO products (name, price, category) VALUES
('Laptop', 1200.00, 'Electronics'),
('Mouse', 25.00, 'Electronics'),
('Keyboard', 75.00, 'Electronics'),
('T-shirt', 20.00, 'Clothing'),
('Jeans', 60.00, 'Clothing');

CREATE VIEW expensive_products AS
SELECT name, price FROM products WHERE price > 100;

SELECT * FROM expensive_products ORDER BY price DESC LIMIT 2;

-- DuckDB specific feature: APPROX_COUNT_DISTINCT
SELECT APPROX_COUNT_DISTINCT(category) FROM products;

-- Attempting to trigger potential overflow issues
CREATE TABLE large_numbers (
    val BIGINT
);

INSERT INTO large_numbers VALUES (9223372036854775807), (-9223372036854775808);

SELECT sum(val) FROM large_numbers;

-- Test window functions with partitioning
SELECT name, price, category, AVG(price) OVER (PARTITION BY category) AS avg_category_price FROM products;

-- Test string functions
SELECT name, UPPER(name), SUBSTRING(name, 1, 3) FROM products;

-- Test CASE statements and boolean logic
SELECT name, price, CASE WHEN price > 50 THEN 'Expensive' ELSE 'Cheap' END AS price_category FROM products;

-- Test correlated subquery
SELECT p1.name FROM products p1 WHERE p1.price > (SELECT AVG(p2.price) FROM products p2 WHERE p2.category = p1.category);

-- Test date functions (DuckDB uses date types differently from some databases)
CREATE TABLE orders (
    order_id INTEGER PRIMARY KEY,
    order_date DATE
);

INSERT INTO orders (order_date) VALUES ('2023-01-15'), ('2023-02-20'), ('2023-03-10');

SELECT order_date, DATE_TRUNC('month', order_date) FROM orders;

-- Test unnesting arrays (DuckDB supports array types)
CREATE TABLE array_test (
    id INTEGER,
    vals INTEGER[]
);

INSERT INTO array_test VALUES (1, ARRAY[1, 2, 3]), (2, ARRAY[4, 5]);

SELECT id, UNNEST(vals) FROM array_test;

-- Test JSON functionality (DuckDB supports JSON)
CREATE TABLE json_test (
    id INTEGER,
    data JSON
);

INSERT INTO json_test VALUES (1, JSON('{"name": "Alice", "age": 30}')), (2, JSON('{"name": "Bob", "age": 25}'));

SELECT id, JSON_EXTRACT_STRING(data, '$.name') FROM json_test;