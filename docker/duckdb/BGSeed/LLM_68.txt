CREATE TABLE orders (
    order_id INTEGER PRIMARY KEY,
    customer_id INTEGER,
    order_date DATE,
    total_amount DECIMAL(10, 2)
);

CREATE TABLE customers (
    customer_id INTEGER PRIMARY KEY,
    first_name VARCHAR,
    last_name VARCHAR,
    email VARCHAR UNIQUE,
    signup_date DATE
);

CREATE TABLE products (
    product_id INTEGER PRIMARY KEY,
    product_name VARCHAR,
    price DECIMAL(10, 2),
    category VARCHAR
);

CREATE TABLE order_items (
    order_item_id INTEGER PRIMARY KEY,
    order_id INTEGER,
    product_id INTEGER,
    quantity INTEGER,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (product_id) REFERENCES products(product_id)
);

CREATE VIEW high_value_customers AS
SELECT c.first_name, c.last_name, SUM(o.total_amount) AS total_spent
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id
HAVING SUM(o.total_amount) > 1000;

-- Insert some sample data
INSERT INTO customers (first_name, last_name, email, signup_date) VALUES
('Alice', 'Smith', 'alice.smith@example.com', '2023-01-15'),
('Bob', 'Johnson', 'bob.johnson@example.com', '2023-02-20'),
('Charlie', 'Brown', 'charlie.brown@example.com', '2023-03-10'),
('David', 'Wilson', 'david.wilson@example.com', '2023-04-05');

INSERT INTO products (product_name, price, category) VALUES
('Laptop', 1200.00, 'Electronics'),
('Keyboard', 75.00, 'Electronics'),
('Mouse', 25.00, 'Electronics'),
('T-Shirt', 20.00, 'Clothing'),
('Jeans', 60.00, 'Clothing');

INSERT INTO orders (customer_id, order_date, total_amount) VALUES
(1, '2023-05-01', 1275.00),
(2, '2023-06-10', 95.00),
(1, '2023-07-15', 80.00),
(3, '2023-08-20', 20.00),
(4, '2023-09-01', 60.00);

INSERT INTO order_items (order_id, product_id, quantity) VALUES
(1, 1, 1),
(1, 2, 1),
(1, 3, 1),
(2, 2, 1),
(2, 3, 1),
(3, 4, 4),
(4, 4, 1),
(5, 5, 1);


-- Example DuckDB specific queries
SELECT APPROX_COUNT_DISTINCT(customer_id) FROM orders;
SELECT quantile(total_amount, 0.5) FROM orders;
SELECT list(product_name) FROM products GROUP BY category;

--More complex queries to test edge cases.
SELECT AVG(total_amount) OVER (ORDER BY order_date) FROM orders;
SELECT customer_id FROM orders GROUP BY customer_id HAVING SUM(total_amount) > (SELECT AVG(total_amount) FROM orders);

--Vacuum command to test compaction
VACUUM;